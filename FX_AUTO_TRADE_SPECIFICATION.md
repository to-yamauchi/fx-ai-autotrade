# FX自動トレードシステム 仕様書

## ドキュメント情報
- **作成日**: 2025-10-21
- **バージョン**: 1.0
- **ステータス**: 設計フェーズ

---

## 目次
1. [システム概要](#1-システム概要)
2. [設計思想](#2-設計思想)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [データ仕様](#4-データ仕様)
5. [AI分析システム](#5-ai分析システム)
6. [トレード実行システム](#6-トレード実行システム)
7. [監視・決済システム](#7-監視決済システム)
8. [バックテスト仕様](#8-バックテスト仕様)
9. [リスク管理](#9-リスク管理)
10. [運用スケジュール](#10-運用スケジュール)
11. [実装ロードマップ](#11-実装ロードマップ)
12. [将来拡張](#12-将来拡張)

---

## 1. システム概要

### 1.1 目的

AIと確定的データを組み合わせた、安全で再現可能なFX自動トレードシステムの構築

### 1.2 基本コンセプト

**3層アーキテクチャ: データ層 → AI判断層 → 高速実行層**

```
【確定的データ層】
- ティックデータの取得
  - バックテスト/モデル作成用: 月単位zipファイル(csv)から取得
  - リアルタイムトレード用: MT5からリアルタイム取得
- 各時間足への変換（D1, H4, H1, M15）
- テクニカル指標の計算
- 再現可能なデータセット生成

↓

【AI判断層】（低頻度・重い処理）
- 市場環境の解釈と分析
- トレード戦略の生成
- ルールベースのJSON出力
- 前日の振り返りと学習

↓

【高速実行層】（高頻度・軽い処理）
- ルールに基づく機械的判定
- リアルタイム監視（100ms〜5分）
- MT5への即座の注文実行
- 緊急停止の高速処理
```

### 1.3 対象通貨ペア

- **Phase 1-4**: USDJPY（単一通貨ペア）
- **Phase 5以降**: 複数通貨ペアへ拡張検討

### 1.4 トレードスタイル

- **基本**: デイトレード（M15ベース）
- **保有時間**: 数時間以内
- **決済**: 23:00に全ポジション強制決済（翌日持ち越しなし）

---

## 2. 設計思想

### 2.1 再現性の確保

**原則**: 同じ市場データ → 同じAI判断 → 検証可能な結果

**実現方法**:
- AIモデルのtemperatureパラメータを低く設定（0.3）
- 全てのデータとプロンプトを記録
- バックテストで同じ条件を再現可能

**目的**:
- トレード判断の分析と改善
- 問題発生時の原因追跡
- システムの継続的改善

### 2.2 安全性最優先

**原則**: 緊急停止は完全ルールベース（AI判断を待たない）

**多層防御**:
1. **保険ストップロス**: MT5に設定（口座の5%）
2. **Layer 1緊急停止**: 口座の2%で即決済（100ms監視）
3. **ハードストップ**: 50pipsで強制決済
4. **異常検知**: スプレッド、急変動の即座検知

**理由**:
- AIの応答を待つ時間的余裕がない緊急時に対応
- 致命的な損失の防止
- システム障害時の安全性確保

### 2.3 柔軟な進化

**原則**: AIが市場変化に適応し、戦略を日々更新

**メカニズム**:
- 毎朝の詳細分析（08:00）で新しい戦略生成
- 前日の振り返り（06:00）から教訓を抽出
- 定期更新（12:00, 16:00, 21:30）で戦略調整
- ポジション監視中のリアルタイム再評価

**目的**:
- 市場環境の変化への適応
- 過去の失敗からの学習
- パフォーマンスの継続的改善

### 2.4 段階的実装

**原則**: 基礎から順に構築し、各段階で検証

**フェーズ**:
1. データ処理と安全装置
2. AI統合と戦略生成
3. バックテストによる検証
4. デモ口座での実運用
5. 本番運用
6. 拡張機能の追加

---

## 3. システムアーキテクチャ

### 3.1 全体構成

```
┌─────────────────────────────────────────┐
│         スケジューラ（週末停止機能）      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         データ処理エンジン                │
│  - データ取得 (zip/csv または MT5)       │
│  - 時間足変換                            │
│  - テクニカル指標計算                    │
│  - データ標準化                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         AI分析エンジン                    │
│  【Gemini API従量課金で統一】           │
│  - Pro: 振り返り、朝分析、緊急評価      │
│  - Flash: 定期更新（3回/日）            │
│  - Flash-Lite: 15分定期評価             │
│  → 月間コスト$1〜2（超低コスト）        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         ルールエンジン（高速実行）         │
│  - Layer 1: 緊急停止（100ms）            │
│  - Layer 2: 異常検知（1分/5分）          │
│  - Layer 3: AI再評価（15分/トリガー時）  │
│  - エントリー監視                        │
│  - 決済監視                              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         データベース                      │
│  - トレード記録                          │
│  - AI判断履歴                            │
│  - 市場データ                            │
│  - バックテスト結果                      │
└─────────────────────────────────────────┘
```

### 3.2 主要コンポーネント

#### 3.2.1 データ処理エンジン

**役割**: 市場データの取得と標準化

**機能**:
- ティックデータ取得
  - **バックテスト/モデル作成用**: 月単位zipファイル(csv)から取得
  - **リアルタイムトレード用**: MT5 API経由でリアルタイム取得
- 日足（D1）、4時間足（H4）、1時間足（H1）、15分足（M15）への変換
- EMA、RSI、MACD等のテクニカル指標計算
- サポート/レジスタンスレベルの算出
- AIが解釈可能な標準フォーマットへの変換

**出力**: 標準化されたJSON形式の市場データセット

#### 3.2.2 AI分析エンジン

**役割**: 市場分析と戦略生成

**使用モデル（全て従量課金）**:

**Gemini API従量課金で統一する理由**:
- サブスク（$60〜100/月）より従量課金（$1〜2/月）の方が圧倒的に安い
- 1つのAPIで統一することでシステムがシンプル
- 必要に応じてモデルを使い分け可能

**モデル選択基準**:

1. **Gemini 2.5 Pro**（高精度・高コスト）
   - 前日振り返り（06:00）
   - 朝の詳細分析（08:00）
   - Layer 3b緊急評価
   - 使用頻度: 3回/日

2. **Gemini 2.5 Flash**（中精度・中コスト）
   - 定期更新（12:00, 16:00, 21:30）
   - 使用頻度: 3回/日

3. **Gemini 2.5 Flash-Lite**（低精度・超低コスト）
   - Layer 3a定期評価（15分ごと）
   - 使用頻度: ポジション保有時のみ（平均10回/日）

**機能**:
- 市場トレンドの判定
- エントリー条件の生成
- リスク管理パラメータの決定
- 決済戦略の策定
- ポジション保有中の再評価
- 前日のトレード分析と教訓抽出

**出力**: 実行可能なルールJSON

**オプション: 多角的分析が必要な場合**:
- 朝の分析（08:00）でProを3回実行し、異なるプロンプトで比較
- コスト: $0.02375 × 3 = $0.07/日でも月$1.5程度

#### 3.2.3 ルールエンジン

**役割**: 高速なルールベース判定と実行

**機能**:
- AI生成ルールの解釈と実行
- 3層監視システムの運用
- エントリー条件の継続的チェック
- 決済条件の監視と実行
- 緊急停止の即座実行

**特徴**: AIを介さない高速処理（100ms〜5分間隔）

#### 3.2.4 データベース

**役割**: 全記録の永続化

**保存データ**:
- トレード記録（エントリー/決済の全詳細）
- AI判断履歴（プロンプトと応答のペア）
- ルール履歴（日次のJSON）
- 市場データスナップショット
- バックテスト結果

**目的**:
- 分析と改善のためのデータ蓄積
- 問題発生時の追跡
- バックテストでの検証

---

## 4. データ仕様

### 4.1 データソース

#### 4.1.1 ティックデータの取得方法

**バックテスト/モデル作成用（推奨）**:
- **形式**: 月単位のzipファイル（中身はcsvファイル）
- **保存場所**: `data/tick_data/USDJPY/`
- **ファイル命名規則**: `USDJPY_YYYY-MM.zip`（例: `USDJPY_2024-09.zip`）
- **csv形式**:
  ```csv
  timestamp,bid,ask,volume
  2024-09-01 00:00:00.123,149.650,149.653,100
  2024-09-01 00:00:00.234,149.651,149.654,150
  ```
- **用途**: AI学習、バックテスト、戦略検証

**リアルタイムトレード用**:
- **形式**: MT5 APIからのリアルタイム取得
- **更新頻度**: ティック単位（価格変動ごと）
- **用途**: 実運用時のエントリー/決済判断、Layer 1監視

**データソース切り替え**:
- バックテストモード: zipファイルから読み込み
- 実運用モード: MT5からリアルタイム取得
- 設定ファイルで切り替え可能

### 4.2 データ保持戦略

システム全体のデータは**3層管理**で効率化：

#### 4.2.1 メモリ常時保持（リアルタイム処理用）

| データ | サイズ | 更新頻度 | 用途 |
|--------|--------|---------|------|
| 現在ティック | 数十B | 100ms | Layer 1監視 |
| 時間足データ（D1/H4/H1/M15） | 50KB | 1分 | エントリー/決済判断 |
| テクニカル指標 | 10KB | 1分 | トレンド判定 |
| 標準化データJSON | 20KB | 1分 | AI分析準備 |
| ルールJSON | 10KB | 定時 | トレード実行基準 |
| ポジション情報 | 数KB | 変動時 | ポジション管理 |

**合計**: 約100KB（非常に軽量）

**重要なポイント**:
- ティックデータは**メモリに蓄積しない**（最新1件のみ保持）
- 時間足データはMT5から**完成済みを取得**（自前で生成しない）
- 古いデータは自動的に破棄（指定本数のみ保持）

#### 4.2.2 メモリ一時保持（処理中のみ）

| データ | サイズ | 用途 |
|--------|--------|------|
| バックテスト用ティック | 数百MB/月 | zipから読み込み、処理後即破棄 |
| 計算中の配列 | 数MB | テクニカル指標計算、完了後破棄 |

#### 4.2.3 DB永続化（履歴・分析用）

| データ | 保存タイミング | 保存期間 |
|--------|--------------|---------|
| トレード記録 | エントリー/決済時 | 永久 |
| AI判断履歴 | AI実行時（1日5-10回） | 永久 |
| ルールJSON履歴 | ルール更新時 | 永久 |
| 市場データスナップショット | AI実行時 | 永久 |
| バックテスト結果 | バックテスト完了時 | 永久 |

**設計思想**:
- **メモリは最小限**: リアルタイム処理に必要な最新データのみ
- **DBは詳細に**: 分析・検証用に全履歴保存
- **一時データは即破棄**: バックテスト用の大量データは処理後即解放

### 4.3 時間足データ

#### 4.3.1 対象時間足

| 時間足 | 取得本数 | 主な用途 |
|--------|----------|----------|
| 日足（D1） | 過去30本 | 長期トレンド判定、サポレジ算出 |
| 4時間足（H4） | 過去50本 | 中期トレンド確認、EMA配列確認 |
| 1時間足（H1） | 過去100本 | メイン分析時間軸、エントリー判定 |
| 15分足（M15） | 過去100本 | 短期シグナル、最終エントリー判断 |

### 4.4 テクニカル指標

#### 4.4.1 トレンド系指標

**トレンド系**:
- EMA(20, 50): トレンド方向の判定
- MACD(12, 26, 9): モメンタム確認

**オシレーター系**:
- RSI(14): 過熱感の判定
- ストキャスティクス: 補助的な売買シグナル

**ボラティリティ系**:
- ATR(14): ポジションサイズ調整
- ボリンジャーバンド(20, 2): レンジ判定

**サポート/レジスタンス**:
- 過去20日の高値・安値
- ピボットポイント
- フィボナッチリトレースメント

### 4.5 データ標準化フォーマット

AIに渡すデータは以下の構造を持つJSON:

```json
{
  "metadata": {
    "timestamp": "2025-10-20 08:00:00",
    "symbol": "USDJPY",
    "current_price": 149.650,
    "data_hash": "abc123..."
  },

  "market_structure": {
    "daily_trend": {
      "direction": "下降",
      "strength": "中程度",
      "ema_alignment": "弱気配列",
      "recent_pattern": "レンジ形成中"
    },
    "h4_trend": { /* ... */ },
    "h1_trend": { /* ... */ },
    "m15_trend": { /* ... */ }
  },

  "technical_summary": {
    "ema": {
      "h1_ema20": 149.580,
      "h1_ema50": 149.720,
      "alignment": "弱気配列",
      "distance": "14pips差"
    },
    "rsi": { /* ... */ },
    "macd": { /* ... */ },
    "bollinger": { /* ... */ },
    "atr": { /* ... */ }
  },

  "key_levels": {
    "support": [149.50, 149.20, 149.00],
    "resistance": [149.70, 149.90, 150.20],
    "pivot": { /* ... */ }
  },

  "recent_price_action": {
    "h1_last_3": [ /* ... */ ],
    "m15_last_5": [ /* ... */ ],
    "summary": "狭いレンジ、方向感なし"
  },

  "volume_analysis": { /* ... */ },
  "session_info": { /* ... */ }
}
```

**特徴**:
- 数値だけでなく、解釈済みの状態も含む
- AIが読みやすい自然言語での説明
- 再現性確保のためのハッシュ値

---

## 5. AI分析システム

### 5.1 分析の種類と頻度

| 分析タイプ | 実行時刻 | 使用モデル | 1回コスト | 目的 |
|-----------|---------|-----------|---------|------|
| 前日振り返り | 06:00 | Gemini 2.5 Pro | $0.018 | 構造化された振り返り、改善点抽出 |
| 朝の詳細分析 | 08:00 | Gemini 2.5 Pro | $0.024 | 市場分析、戦略生成 |
| 定期更新（昼） | 12:00 | Gemini 2.5 Flash | $0.002 | 午前の総括、戦略調整 |
| 定期更新（夕方） | 16:00 | Gemini 2.5 Flash | $0.002 | 欧州市場前の確認 |
| 定期更新（夜） | 21:30 | Gemini 2.5 Flash | $0.002 | NY市場前の確認 |
| ポジション定期評価 | 15分ごと | Gemini 2.5 Flash-Lite | $0.0003 | 保有中の簡易チェック |
| ポジション緊急評価 | トリガー時 | Gemini 2.5 Pro | $0.018 | 異常時の詳細判断 |

**1日の合計コスト**: 約$0.07（月$1.5、年$18）

### 5.2 多角的分析のオプション

**オプションA: 朝の分析で複数視点を得る方法**

Gemini Pro 1回実行だけでなく、異なるプロンプトで3回実行して比較:

1. **テクニカル重視プロンプト**
   - チャートパターン分析
   - テクニカル指標の詳細評価
   - 価格アクションの解釈

2. **リスク管理重視プロンプト**
   - 市場環境の構造化評価
   - エントリー/決済ルールの論理的構築
   - 最悪シナリオの分析

3. **トレンド重視プロンプト**
   - 大局的なトレンド判定
   - 市場心理の解釈
   - セッション別の傾向分析

**コスト**: $0.024 × 3 = $0.072/日（月$1.6追加）

**統合処理**:
- 3つの出力を比較
- 一致度が高い判断を優先
- 矛盾がある場合は保守的な判断（NEUTRALまたはエントリー見送り）
- 最終的なルールJSONは最も保守的な条件を採用

**オプションB: 単一実行（推奨）**

- Gemini Pro 1回のみ、包括的なプロンプト
- コスト削減優先
- 月$1.5で運用

### 5.3 前日振り返り（06:00）

**入力**:
- 前日のトレード記録
- 前日の予測内容
- 実際の市場動向
- 損益と統計データ

**処理**:
- 予測と結果の比較分析
- 成功・失敗要因の特定
- パターン認識
- 改善点の抽出

**出力**:
```json
{
  "score": {
    "direction": "X/40点",
    "entry_timing": "X/20点",
    "exit_timing": "X/20点",
    "risk_management": "X/20点",
    "total": "X/100点"
  },

  "analysis": {
    "what_worked": ["成功要因1", "成功要因2"],
    "what_failed": ["失敗要因1", "失敗要因2"],
    "missed_signals": ["見落とした機会1"]
  },

  "lessons_for_today": [
    "教訓1: 具体的な改善アクション",
    "教訓2: ...",
    "教訓3: ..."
  ],

  "pattern_recognition": {
    "success_patterns": ["成功パターン1"],
    "failure_patterns": ["失敗パターン1"]
  }
}
```

### 5.4 朝の詳細分析（08:00）

**使用AI**: Gemini 2.5 Pro（従量課金）

**入力**:
- 標準化された市場データ
- 前日の振り返り結果
- 過去5日の統計

**処理**:
- 市場環境の総合判断
- トレンド方向とバイアスの決定
- エントリー条件の生成
- リスク管理パラメータの設定
- 決済戦略の策定

**出力**:
```json
{
  "daily_bias": "BUY/SELL/NEUTRAL",
  "confidence": 0.75,
  "reasoning": "詳細な判断理由",

  "market_environment": {
    "trend": "上昇/下降/レンジ/転換期",
    "strength": "強い/中程度/弱い",
    "phase": "初期/中期/末期"
  },

  "entry_conditions": {
    "should_trade": true,
    "direction": "BUY/SELL",
    "price_zone": {"min": 149.50, "max": 149.70},
    "required_signals": [
      "具体的条件1",
      "具体的条件2"
    ],
    "avoid_if": [
      "回避条件1",
      "回避条件2"
    ]
  },

  "exit_strategy": {
    "take_profit": [
      {"pips": 10, "close_percent": 30},
      {"pips": 20, "close_percent": 40},
      {"pips": 30, "close_percent": 100}
    ],
    "stop_loss": {
      "initial": "account_2_percent",
      "trailing": {
        "activate_at_pips": 15,
        "trail_percent": 50
      }
    },
    "indicator_exits": [
      {
        "condition": "MACDデッドクロス",
        "action": "CLOSE_ALL"
      }
    ],
    "time_exits": {
      "max_hold_minutes": 240,
      "force_close_time": "23:00"
    }
  },

  "risk_management": {
    "position_size_multiplier": 0.8,
    "max_positions": 1,
    "reason": "ボラティリティやや高め"
  },

  "key_levels": {
    "entry_target": 149.60,
    "invalidation_level": 149.80,
    "critical_support": 149.50,
    "critical_resistance": 149.70
  },

  "scenario_planning": {
    "bullish_scenario": "149.70抜けたら150.00目指す",
    "bearish_scenario": "149.50割れたら149.00へ",
    "base_case": "レンジ継続の可能性60%"
  },

  "lessons_applied": [
    "昨日の教訓: レンジ時の早期利確 → 今日: +15pipsで50%決済"
  ]
}
```

### 5.5 定期更新（12:00, 16:00, 21:30）

**使用AI**: Gemini 2.5 Flash（従量課金）

**目的**: 朝の予測の妥当性確認と必要に応じた修正

**入力**:
- 朝の予測内容
- 更新時刻までの実際の動き
- 現在の市場状況

**処理**:
- 予測の有効性評価
- 市場変化の重要性判定
- ルール修正の必要性判断

**出力**:
```json
{
  "prediction_status": "有効/要修正/無効",
  "confidence_update": 0.75,
  "reasoning": "午前中は予想通りレンジ、予測継続",
  "action": "継続/修正/中止",

  "rule_updates": {
    // 修正が必要な場合のみ
    "entry_conditions": {},
    "key_levels": {}
  }
}
```

### 5.6 ポジション監視

#### 5.6.1 定期評価（15分ごと）

**使用AI**: Gemini 2.5 Flash-Lite（従量課金）

**条件**: ポジション保有中のみ

**目的**: 超高速・超低コストの簡易チェックで異常を早期発見

**Flash-Lite最適化**:
- プロンプト長: 最大500トークン（市場データを極限まで圧縮）
- 出力長: 最大100トークン（JSON形式のみ、説明文なし）
- 応答時間: 1秒以内を目標

**入力**:
- エントリー情報
- 現在の含み損益
- 直近の価格動き
- 主要指標の現在値

**出力**:
```json
{
  "status": "OK/WARNING/DANGER",
  "action": "HOLD/CLOSE_PARTIAL/CLOSE_ALL",
  "reason": "予想通りの動き、継続"
}
```

#### 5.6.2 緊急評価（トリガー時）

**使用AI**: Gemini 2.5 Pro（従量課金）

**条件**: Layer 2が異常を検知した時

**目的**: 詳細分析で的確な判断（高精度が必要なため従量課金でも可）

**入力**:
- ポジション全情報
- 過去1時間の価格推移
- 全インジケーター値
- トリガー理由
- 元の予測内容

**出力**:
```json
{
  "prediction_validity": "VALID/PARTIALLY_INVALID/FULLY_INVALID",
  "decision": "HOLD/CLOSE_25/CLOSE_50/CLOSE_75/CLOSE_ALL",
  "confidence": 0.85,
  "reasoning": "重要レジスタンス明確にブレイク、当初シナリオ崩壊、撤退推奨",
  "urgency": "LOW/MEDIUM/HIGH",
  "stop_loss_adjustment": 149.75,
  "alternative_plan": "149.80でBUYに転換検討"
}
```

---

## 6. トレード実行システム

### 6.1 エントリー判断フロー

```
【継続的監視（1分ごと）】

Step 1: トレード可否確認
  - daily_bias が NEUTRAL → エントリーしない
  - should_trade が false → エントリーしない

Step 2: 価格ゾーンチェック
  - 現在価格が price_zone の範囲内か確認
  - 範囲外 → 待機

Step 3: 必須シグナルチェック
  - required_signals の全条件を確認
  - 1つでも未達 → 待機
  - 全て達成 → 次へ

Step 4: 回避条件チェック
  - avoid_if の各条件を確認
  - 1つでも該当 → 見送り
  - 全て回避 → 次へ

Step 5: 最終ガードレール
  - スプレッド > 10pips → 見送り
  - 口座残高不足 → 見送り
  - 重要指標発表30分以内 → 見送り
  - 全てクリア → エントリー実行
```

### 6.2 エントリー実行

#### 6.2.1 ポジションサイズ決定

**基本ロット**: 0.1 lot

**調整倍率**: AI生成の position_size_multiplier（0.5〜1.0）

**最終ロット** = 基本ロット × 調整倍率

**調整例**:
- 確信度高い、ボラティリティ通常: 1.0倍（0.1 lot）
- 確信度中程度: 0.7倍（0.07 lot）
- 確信度低い、ボラティリティ高: 0.5倍（0.05 lot）

#### 6.2.2 ストップロス設定

**2段階の防御**:

1. **保険ストップロス（MT5に設定）**:
   - 口座の5%に相当
   - 例: 10万ドル口座、0.1 lot → 約500pips離れた位置
   - 目的: 万が一のシステム障害時の最終防衛線

2. **実質ストップロス（Layer 1で監視）**:
   - 口座の2%で強制決済
   - ハードストップ: 50pips
   - 目的: 実際の損失管理

#### 6.2.3 注文実行

**注文タイプ**:
- 成行注文: 即座のエントリーが必要な場合
- 指値注文: 価格ゾーンのエッジでのエントリー狙い

**利確設定**: なし（動的に管理）

#### 6.2.4 記録

**保存情報**:
- エントリー時刻
- エントリー価格
- ロットサイズ
- 方向（BUY/SELL）
- AI判断内容（JSON全体）
- 市場データスナップショット
- エントリー理由（満たした条件）

---

## 7. 監視・決済システム

### 7.1 3層監視構造

#### Layer 1: 緊急停止（100msごと）

**目的**: 致命的損失の即座防止

**監視項目**:

1. **口座の2%損失**
   - 検知: ポジション含み損 > 口座残高 × 2%
   - 処理: 即座に成行決済
   - 記録: "Emergency: 2% loss limit"

2. **ハードストップ（50pips）**
   - 検知: エントリーから50pips逆行
   - 処理: 即座に成行決済
   - 記録: "Hard stop: 50pips"

3. **スプレッド異常**
   - 検知: スプレッド > 20pips
   - 処理: 即座に成行決済
   - 記録: "Spread alert"

4. **フラッシュクラッシュ**
   - 検知: 0.1秒で30pips以上変動
   - 処理: 即座に成行決済
   - 記録: "Flash crash detected"

**特徴**:
- 完全にルールベース（AI不使用）
- 最高速実行（100ms間隔）
- 確実性最優先

#### Layer 2: 異常検知（1分 + 5分定期）

**目的**: 市場環境変化の早期発見

**1分ごとの監視**:

1. **重要レベルブレイク**
   - BUYポジション: critical_support 割れ → Layer 3へ
   - SELLポジション: critical_resistance 抜け → Layer 3へ

2. **インジケーター反転**
   - BUYポジション: MACDデッドクロス → Layer 3へ
   - SELLポジション: MACDゴールデンクロス → Layer 3へ

3. **連続逆行**
   - 15分足で3本連続逆方向 → Layer 3へ

**5分ごとの監視**:

4. **AI避けるべき条件**
   - avoid_if 条件の発生チェック
   - 該当 → Layer 3へ

5. **RSI過熱**
   - RSI > 80 (BUY) または RSI < 20 (SELL)
   - 該当 → Layer 3へ

**特徴**:
- ルールベースの検知
- 自動決済はしない（Layer 3に判断を委ねる）
- トリガー時は即座にエスカレーション

#### Layer 3: AI再評価

**Layer 3a: 定期評価（15分ごと）**

- **条件**: ポジション保有中
- **モデル**: Gemini 2.5 Flash-Lite（超低コスト）
- **入力**: 簡易データ（エントリー情報、現在状況、直近の動き）
- **出力**: OK/WARNING/DANGER、HOLD/CLOSE_PARTIAL/CLOSE_ALL
- **処理**:
  - DANGER → Layer 3bへエスカレーション
  - CLOSE指示 → 実行
  - それ以外 → 記録のみ

**Layer 3b: 緊急評価（Layer 2トリガー時）**

- **条件**: Layer 2が異常検知
- **モデル**: Gemini 2.5 Pro（高精度）
- **入力**: 詳細データ（全ポジション情報、過去1時間の推移、トリガー理由）
- **出力**: 予測の妥当性、決済判断、信頼度、詳細理由
- **処理**:
  - HIGH urgency + CLOSE → 即座に実行
  - MEDIUM urgency → ストップ調整または部分決済
  - それ以外 → 記録のみ

### 7.2 段階的利確

**仕組み**: AI生成の take_profit ルールに従う

**例**:
```json
[
  {"pips": 10, "close_percent": 30},
  {"pips": 20, "close_percent": 40},
  {"pips": 30, "close_percent": 100}
]
```

**実行**:
- +10pips到達: 30%決済（残り70%）
- +20pips到達: 40%決済（残り30%）
- +30pips到達: 全決済

**目的**:
- 利益の確実な確保
- ポジション全体が逆行するリスク低減
- 大きな利益を伸ばす機会も維持

### 7.3 トレーリングストップ

**仕組み**: 含み益が一定水準を超えたら利益を守る

**パラメータ例**:
```json
{
  "activate_at_pips": 15,
  "trail_percent": 50
}
```

**動作**:
- 含み益+15pips到達: トレーリング開始
- 含み益+20pips: ストップを+10pips（20 × 50%）に設定
- 含み益+30pips: ストップを+15pips（30 × 50%）に移動
- 価格が+15pipsまで戻る: ストップ発動、決済

**更新頻度**: 1分ごとにストップ位置を再計算

### 7.4 時間管理

**ルール**:

1. **2時間経過 かつ ±5pips以内**:
   - 決済実行
   - 理由: 機会損失回避（横ばい）

2. **4時間経過**:
   - 含み益 > 0: 全決済（利益確保）
   - 含み損 > 0: 継続（但し-1%以内の場合のみ）

3. **23:00到達**:
   - 全ポジション強制決済
   - 理由: 日次クローズ（翌日持ち越しなし）

---

## 8. バックテスト仕様

### 8.1 疑似バックテストの概念

**背景**: 従来のバックテストとの違い

- **従来**: 過去データで戦略をシミュレーション
- **疑似**: 過去データでAIの判断を再現・評価

**目的**:
- AIの判断精度を検証
- 判断の一貫性を確認
- 実際の運用前の信頼性評価

### 8.2 実行プロセス

```
【期間指定】例: 2024年9月1日〜30日

【各営業日ごとに】

1. 08:00時点のデータスナップショット取得
   - その時点から見た過去データ（D1, H4, H1, M15）
   - テクニカル指標

2. データ標準化
   - 本番と同じフォーマットに変換

3. AI分析を3回実行（再現性確認）
   - 同じデータで3回分析
   - temperature: 0.3（本番と同じ）
   - 各応答を記録

4. 一貫性チェック
   - 3回の予測が一致するか
   - daily_bias の一致率
   - confidence の標準偏差

5. 実際の結果取得
   - その日の高値・安値・終値
   - 値幅
   - 方向性

6. 評価
   - 予測の的中/外れ
   - エントリー判断の妥当性
   - 仮想損益の計算
```

### 8.3 評価指標

#### 8.3.1 方向性的中率

- AI予測の daily_bias と実際の動きを比較
- BUY予測で上昇 → 的中
- SELL予測で下降 → 的中
- NEUTRAL予測で小動き → 的中

#### 8.3.2 エントリー判断の妥当性

- should_trade = true で実際に20pips以上動いた → 妥当
- should_trade = false で±5pips以内 → 妥当
- should_trade = true だが動かなかった → 不適切

#### 8.3.3 判断の一貫性

- 同じデータで3回実行した結果の一致度
- daily_bias が3回とも同じ → 一貫性100%
- confidence の標準偏差 → 小さいほど安定

#### 8.3.4 仮想損益

- AI条件でエントリーしたと仮定
- 決済ルールに従って決済と仮定
- トータルの損益を計算

### 8.4 結果レポート

**サマリー**:
- 対象期間と営業日数
- 方向性的中率
- エントリー判断妥当性
- 判断の一貫性
- 仮想損益の統計

**詳細分析**:
- 成功パターンの特定
- 失敗パターンの特定
- 市場環境別の成績

**改善提案**:
- プロンプトの調整案
- ルールの修正案
- パラメータの最適化案

---

## 9. リスク管理

### 9.1 口座保護の多層防御

```
Level 1: 保険ストップロス（MT5）
  - 口座の5%
  - 最終防衛線（システム障害時）

Level 2: Layer 1監視
  - 口座の2%で強制決済
  - ハードストップ50pips
  - 100ms高速監視

Level 3: Layer 2異常検知
  - サポレジブレイク
  - インジケーター反転
  - Layer 3へエスカレーション

Level 4: Layer 3 AI判断
  - 定期評価（15分）
  - 緊急評価（トリガー時）
  - 柔軟な意思決定
```

### 9.2 ポジションサイズ管理

**基本方針**: 保守的なサイジング

- **基本**: 0.1 lot
- **調整範囲**: 0.05〜0.1 lot
- **調整要因**:
  - AI信頼度
  - 市場ボラティリティ
  - 口座残高

**最大ポジション数**: 1（Phase 1-4）

### 9.3 ドローダウン管理

**最大許容ドローダウン**: 10%

**段階的対応**:

- **5%到達**: 警戒レベル
  - ポジションサイズを50%に縮小
  - エントリー条件を厳格化

- **7%到達**: 危険レベル
  - ポジションサイズを最小（0.05 lot）に
  - 確信度0.8以上のみエントリー

- **10%到達**: 停止レベル
  - 全トレード停止
  - 徹底的な分析と改善
  - 再開には明確な改善策が必要

### 9.4 週次・月次チェック

**週次レビュー**:
- 損益の確認
- ドローダウンのチェック
- パフォーマンス指標の評価

**月次レビュー**:
- バックテストとの比較
- AI判断精度の推移
- システム全体の改善点抽出

---

## 10. 運用スケジュール

### 10.1 週末停止

**土日の処理**:
- 新規エントリー完全停止
- Layer 1のみ稼働（万が一のポジション監視）
- その他の処理は全停止

**金曜日23:00**: 全ポジション強制決済

**月曜日07:00**: 全機能自動復帰

### 10.2 平日スケジュール

| 時刻 | 処理 | モデル | 1回コスト | 目的 |
|------|------|--------|---------|------|
| 06:00 | 前日振り返り | Gemini 2.5 Pro | $0.018 | 教訓抽出 |
| 08:00 | 朝の詳細分析 | Gemini 2.5 Pro | $0.024 | 市場分析、戦略生成 |
| 12:00 | 定期更新 | Gemini 2.5 Flash | $0.002 | 午前の総括 |
| 16:00 | 定期更新 | Gemini 2.5 Flash | $0.002 | 欧州前チェック |
| 21:30 | 定期更新 | Gemini 2.5 Flash | $0.002 | NY前チェック |
| 23:00 | 強制決済 | - | - | 日次クローズ |

**1日の戦略生成コスト合計**: $0.048

### 10.3 継続監視

| 監視種類 | 頻度 | 使用技術 | コスト | 目的 |
|---------|------|---------|--------|------|
| Layer 1緊急停止 | 100ms | ルールベース | $0 | 致命的損失防止 |
| エントリー監視 | 1分 | ルールベース | $0 | 条件達成チェック |
| Layer 2異常検知 | 1分/5分 | ルールベース | $0 | 環境変化検知 |
| 決済監視 | 1分 | ルールベース | $0 | 利確・損切・時間管理 |
| Layer 3a定期評価 | 15分 | Flash-Lite（従量） | 超低 | ポジション簡易チェック |
| Layer 3b緊急評価 | トリガー時 | Pro（従量） | 中 | 異常時詳細分析 |

---

## 11. 実装ロードマップ

### Phase 1: 基礎実装（Week 1-2）

**目標**: データ処理と安全装置の構築

**内容**:
- MT5接続とデータ取得機能
- 各時間足への変換機能
- テクニカル指標計算
- データ標準化機能
- Layer 1緊急停止システム
- データベース設計と実装
- 週末停止機能

**成果物**:
- 安定したデータ取得
- 基本的な安全装置の動作確認

### Phase 2: AI統合（Week 3）

**目標**: AI分析機能の実装

**内容**:
- Gemini API統合
- プロンプト設計と最適化
- 前日振り返り機能（06:00）
- 朝の詳細分析機能（08:00）
- 定期更新機能（12:00, 16:00, 21:30）
- ルールJSON生成

**成果物**:
- 実行可能なルールJSONの出力
- AI判断の記録と分析

### Phase 3: トレード実行（Week 3-4）

**目標**: 完全な自動トレードシステム

**内容**:
- ルールエンジン実装
- エントリー監視と実行
- Layer 2異常検知
- Layer 3 AI再評価
- 決済システム（利確・損切・時間管理）
- MT5注文実行

**成果物**:
- エンドツーエンドの自動トレード

### Phase 4: バックテスト（Week 4）

**目標**: システムの信頼性検証

**内容**:
- 疑似バックテスト実装
- 過去1〜3ヶ月のデータで検証
- 再現性確認（複数回実行）
- 統計分析とレポート生成

**成果物**:
- バックテスト結果レポート
- AI判断精度の定量評価
- 改善点の特定

### Phase 5: デモ運用（Week 5-8）

**目標**: 実環境での動作検証と調整

**内容**:
- デモ口座での実運用開始
- 最小ロット（0.01 lot）から開始
- リアルタイム監視
- プロンプトの継続的改善
- パラメータ調整
- 問題点の洗い出しと修正

**成果物**:
- 4週間の運用実績
- 改善されたプロンプトとルール
- 本番運用の準備完了

### Phase 6: 本番運用（Week 9-）

**目標**: 実資金での運用開始

**内容**:
- 少額資金から開始
- ロットサイズの段階的増加
- リアルタイムパフォーマンス分析
- 継続的な最適化
- 定期的なバックテストとの比較

**段階的増加例**:
- Week 9-10: 0.05 lot
- Week 11-12: 0.07 lot
- Week 13-: 0.1 lot（標準）

### Phase 7: 拡張機能（将来）

**候補機能**:
- ニュース統合
- 複数通貨ペア対応
- 複数時間軸エントリー
- 機械学習モデル追加
- 高度なリスク管理
- 通知システム

---

## 12. 将来拡張

### 12.1 ニュース統合（Phase 7以降）

**目的**: ファンダメンタルズ分析の追加

**実装内容**:
- Bloomberg/Reuters等のニュースAPI統合
- 経済指標カレンダーの取得
- AIによるニュース感情分析
- 分析への統合（プロンプト拡張）

**期待効果**:
- 重要指標前の回避
- ニュースドリブンな動きの予測
- トレード精度の向上

### 12.2 複数通貨ペア対応

**目的**: ポートフォリオの分散

**対象候補**:
- EURUSD
- GBPUSD
- AUDUSD
- その他主要ペア

**実装内容**:
- 通貨ペアごとの独立戦略
- ポートフォリオ管理機能
- 相関分析

### 12.3 複数時間軸エントリー

**目的**: 多様なトレード機会の捕捉

**候補**:
- スキャルピング（M5ベース）
- デイトレード（M15ベース）- 現行
- スイング（H4/D1ベース）

**実装内容**:
- 各時間軸専用の戦略
- 複数ポジションの管理
- リスク配分の最適化

### 12.4 機械学習モデル追加

**目的**: AI判断の精度向上

**内容**:
- 過去データからのパターン学習
- アンサンブル手法（Gemini + ML）
- 継続的な学習と改善

### 12.5 高度なリスク管理

**目的**: より洗練されたリスクコントロール

**内容**:
- ポートフォリオVaR計算
- 動的ポジションサイジング
- ドローダウン予測と対策

### 12.6 通知システム

**目的**: 重要イベントのリアルタイム通知

**内容**:
- Slack/LINE/Email統合
- エントリー/決済通知
- 異常検知アラート
- 日次/週次レポート

---

## 13. コスト試算

### 13.1 AIコスト（Gemini API従量課金のみ）

**公式料金ページ**: https://ai.google.dev/gemini-api/docs/pricing

**料金（2025年10月時点）**:

- **Gemini 2.5 Pro**（高精度分析用）:
  - 入力: $1.25 / 1M tokens = $0.00125 / 1K tokens
  - 出力: $10.00 / 1M tokens = $0.01 / 1K tokens

- **Gemini 2.5 Flash**（定期更新用）:
  - 入力: $0.30 / 1M tokens = $0.0003 / 1K tokens
  - 出力: $2.50 / 1M tokens = $0.0025 / 1K tokens

- **Gemini 2.5 Flash-Lite**（15分定期評価専用）:
  - 入力: $0.10 / 1M tokens = $0.0001 / 1K tokens
  - 出力: $0.40 / 1M tokens = $0.0004 / 1K tokens

**Gemini従量課金で統一する理由**:
- サブスク（$60〜100/月）と比較して**95%以上のコスト削減**
- 単一APIで管理がシンプル
- 使った分だけ課金で無駄なし

### 13.2 1日のコスト内訳（基本プラン）

| 処理 | モデル | 回数 | 入力 | 出力 | コスト |
|------|--------|------|------|------|--------|
| 前日振り返り | Pro | 1 | 2K | 1.5K | $0.0025 + $0.015 = $0.0175 |
| 朝の詳細分析 | Pro | 1 | 3K | 2K | $0.00375 + $0.02 = $0.02375 |
| 定期更新×3 | Flash | 3 | 1.5K×3 | 0.5K×3 | $0.00135 + $0.00375 = $0.0051 |
| Layer 3a定期評価 | Flash-Lite | 10 | 0.5K×10 | 0.1K×10 | $0.0005 + $0.0004 = $0.0009 |
| Layer 3b緊急評価 | Pro | 1 | 2K | 1.5K | $0.0025 + $0.015 = $0.0175 |

**1日合計**: $0.065

**月間（22営業日）**: $1.43

**年間（250営業日）**: $16.25

### 13.3 コスト詳細分析

#### 13.3.1 Flash-Lite 15分定期チェックのコスト

**プロンプト仕様**:
- 入力: 500トークン（極限まで圧縮）
- 出力: 100トークン（JSON形式のみ）
- 実行頻度: 15分ごと = 1時間4回

**シナリオ別コスト計算**:

#### シナリオ1: ポジション保有時のみ実行（推奨）
- 1日平均保有時間: 2〜3時間
- 実行回数/日: 8〜12回
- 実行回数/月: 176〜264回（22営業日）

**月間コスト**:
- 入力: 500トークン × 220回 = 110K tokens = 0.11M
- 出力: 100トークン × 220回 = 22K tokens = 0.022M
- 入力コスト: 0.11M × $0.10 = **$0.011**
- 出力コスト: 0.022M × $0.40 = **$0.0088**
- **合計: 約$0.02/月**（年間$0.24）

#### シナリオ2: 取引時間中常時監視
- 取引時間: 平日08:00〜23:00（15時間）
- 実行回数/日: 60回
- 実行回数/月: 1,320回（22営業日）

**月間コスト**:
- 入力: 500 × 1,320 = 660K = 0.66M
- 出力: 100 × 1,320 = 132K = 0.132M
- 入力コスト: 0.66M × $0.10 = **$0.066**
- 出力コスト: 0.132M × $0.40 = **$0.0528**
- **合計: 約$0.12/月**（年間$1.44）

#### シナリオ3: 24時間フル監視（非推奨）
- 実行回数/日: 96回
- 実行回数/月: 2,112回（22営業日）

**月間コスト**:
- 入力: 500 × 2,112 = 1.056M
- 出力: 100 × 2,112 = 0.2112M
- 入力コスト: 1.056M × $0.10 = **$0.1056**
- 出力コスト: 0.2112M × $0.40 = **$0.0845**
- **合計: 約$0.19/月**（年間$2.28）

**推奨設定**: シナリオ1（ポジション保有時のみ）
- 月間$0.02と極めて低コスト
- 必要な時だけ監視で効率的
- 年間でも$0.24

#### 13.3.2 多角的分析オプションのコスト

**オプションA: 朝の分析を3回実行**

| 処理 | モデル | 回数 | 入力 | 出力 | コスト |
|------|--------|------|------|------|--------|
| 朝の分析（テクニカル重視） | Pro | 1 | 3K | 2K | $0.02375 |
| 朝の分析（リスク管理重視） | Pro | 1 | 3K | 2K | $0.02375 |
| 朝の分析（トレンド重視） | Pro | 1 | 3K | 2K | $0.02375 |

**追加コスト**: $0.0475/日（月$1.05、年$11.88）

**基本プラン + オプションA**:
- 月間: $1.43 + $1.05 = **$2.48**
- 年間: $16.25 + $11.88 = **$28.13**

### 13.4 総コスト試算

| プラン | 月額 | 年額 | 特徴 |
|--------|------|------|------|
| 基本（Gemini従量課金のみ） | **$1.43** | **$16.25** | シンプル、超低コスト |
| オプションA（多角的分析） | **$2.48** | **$28.13** | 3つの視点で分析 |
| 参考: サブスク想定 | $60〜100 | $720〜1,200 | 従量課金の40〜70倍 |

**結論**:
- **Gemini従量課金で月$1.43は極めて低コスト**
- サブスクと比較して**95%以上のコスト削減**
- 多角的分析を追加しても月$2.48と低い
- 総コストは完全に予測可能

### 13.5 Flash-Lite最適化の詳細

**プロンプト圧縮技術**:
```json
{
  "pos": "SELL@149.68,12min,-3p",
  "now": "149.71",
  "m15": ["↓","↑","↑"],
  "rsi": "62→68↑",
  "plan": "149.70反発"
}
```

**出力最小化**:
```json
{"s":"WARNING","a":"HOLD","r":"slight reversal"}
```

**効果**:
- 入力: 3,000トークン → 500トークン（83%削減）
- 出力: 500トークン → 100トークン（80%削減）
- 応答時間: 3秒 → 1秒以内（67%高速化）
- コスト: $0.0015/回 → $0.00027/回（82%削減）

### 13.6 その他コスト

- **MT5 VPS**: $10〜30/月（オプション）
- **データフィード**: 無料（MT5経由）
- **インフラ**: サーバー代（既存環境利用可）

**総運用コスト想定**:
- AIコスト: $1.43/月
- VPS（オプション）: $10〜30/月
- **合計**: $11〜31/月（VPS利用時）、または$1.43/月（自宅サーバー利用時）

---

## 14. リスクと制約事項

### 14.1 技術的リスク

**AI判断の不確実性**:
- 対策: 低温度パラメータ（0.3）、バックテストでの検証
- 対策: ルールベースの安全装置

**MT5接続の不安定性**:
- 対策: 再接続ロジック、タイムアウト処理
- 対策: 接続エラー時のアラート

**システム障害**:
- 対策: 保険ストップロスの必須設定
- 対策: Layer 1の独立稼働

### 14.2 市場リスク

**急激な市場変動**:
- 対策: フラッシュクラッシュ検知
- 対策: スプレッド異常検知

**週末ギャップ**:
- 対策: 金曜23:00の強制決済
- 対策: 週末の完全停止

**重要指標発表**:
- 対策: 発表30分以内のエントリー見送り
- 対策: 将来的にカレンダー統合

### 14.3 運用リスク

**過信による損失拡大**:
- 対策: 厳格なドローダウン管理（5%, 7%, 10%）
- 対策: 定期的なパフォーマンスレビュー

**プロンプトの劣化**:
- 対策: 継続的なバックテストでの検証
- 対策: デモ運用での調整期間

---

## 15. 成功指標（KPI）

### 15.1 技術指標

- **システム稼働率**: 99%以上
- **データ取得成功率**: 99.5%以上
- **AI応答時間**: 平均5秒以内
- **緊急停止応答時間**: 100ms以内

### 15.2 パフォーマンス指標

- **月次勝率**: 60%以上
- **プロフィットファクター**: 1.5以上
- **最大ドローダウン**: 10%以下
- **リスクリワード比**: 1:2以上

### 15.3 AI精度指標

- **方向性的中率**: 65%以上
- **判断の一貫性**: 90%以上
- **エントリー判断妥当性**: 70%以上

---

## 16. まとめ

### 16.1 システムの強み

1. **再現性**: 同じデータから同じ判断を生成
2. **安全性**: 多層防御による口座保護
3. **学習能力**: 前日の振り返りからの継続改善
4. **超低コスト**: Gemini従量課金で**月$1.43**（年$16）と極めて低い
5. **シンプル**: 単一API（Gemini）で管理が容易
6. **柔軟性**: 段階的な拡張が可能（多角的分析オプション等）

### 16.2 成功のカギ

1. **プロンプト設計**: AI判断の質を左右
2. **バックテスト**: 本番前の徹底検証
3. **段階的運用**: デモ→小額→標準の慎重なアプローチ
4. **継続改善**: データに基づく最適化

### 16.3 次のステップ

1. 仕様の最終レビューと承認
2. Phase 1実装の着手
3. 開発環境のセットアップ
4. データ処理機能の実装開始

---

**以上、FX自動トレードシステムの仕様書**

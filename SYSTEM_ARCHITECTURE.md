# FX自動トレードシステム - システムアーキテクチャ仕様

## ドキュメント情報
- **作成日**: 2025-10-21
- **対象システム**: FX AI自動トレードシステム (USDJPY)
- **バージョン**: 1.0

---

## 1. アーキテクチャ概要

### 1.1 基本構成

本システムは**3層アーキテクチャ**を採用し、データ処理、AI判断、高速実行を分離しています。

```
┌─────────────────────────────────────────┐
│     【確定的データ層】                    │
│   - MT5からの正確なティックデータ取得      │
│   - 各時間足への変換 (D1, H4, H1, M15)   │
│   - テクニカル指標の計算                  │
│   - 再現可能なデータセット生成             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│     【AI判断層】(低頻度・重い処理)         │
│   - 市場環境の解釈と分析                  │
│   - トレード戦略の生成                    │
│   - ルールベースのJSON出力                │
│   - 前日の振り返りと学習                  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│     【高速実行層】(高頻度・軽い処理)       │
│   - ルールに基づく機械的判定              │
│   - リアルタイム監視 (100ms〜5分)        │
│   - MT5への即座の注文実行                │
│   - 緊急停止の高速処理                   │
└─────────────────────────────────────────┘
```

### 1.2 設計原則

| 原則 | 説明 | 実現方法 |
|------|------|----------|
| **再現性の確保** | 同じ市場データ → 同じAI判断 → 検証可能な結果 | AIモデルのtemperature=0.3、全データとプロンプトを記録 |
| **安全性最優先** | 緊急停止は完全ルールベース (AI判断を待たない) | 多層防御: 100ms監視、口座の2%で即決済、50pipsハードストップ |
| **柔軟な進化** | AIが市場変化に適応し、戦略を日々更新 | 毎朝の詳細分析、定期更新、ポジション監視中のリアルタイム再評価 |
| **段階的実装** | 基礎から順に構築し、各段階で検証 | 6フェーズの段階的ロードマップ |

---

## 2. システムコンポーネント

### 2.1 全体構成図

```
┌─────────────────────────────────────────┐
│      スケジューラ (週末停止機能)          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         データ処理エンジン                │
│  - MT5接続とデータ取得                   │
│  - 時間足変換                            │
│  - テクニカル指標計算                    │
│  - データ標準化                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         AI分析エンジン                    │
│  【Gemini API従量課金で統一】           │
│  - Pro: 振り返り、朝分析、緊急評価      │
│  - Flash: 定期更新 (3回/日)            │
│  - Flash-Lite: 15分定期評価             │
│  → 月間コスト$1〜2 (超低コスト)        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         ルールエンジン (高速実行)         │
│  - Layer 1: 緊急停止 (100ms)            │
│  - Layer 2: 異常検知 (1分/5分)          │
│  - Layer 3: AI再評価 (15分/トリガー時)  │
│  - エントリー監視                        │
│  - 決済監視                              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         データベース                      │
│  - トレード記録                          │
│  - AI判断履歴                            │
│  - 市場データ                            │
│  - バックテスト結果                      │
└─────────────────────────────────────────┘
```

### 2.2 主要コンポーネント詳細

#### 2.2.1 データ処理エンジン

**役割**: 市場データの取得と標準化

**機能**:
- MT5 API経由でのティックデータ取得
- 日足(D1)、4時間足(H4)、1時間足(H1)、15分足(M15)への変換
- EMA、RSI、MACD等のテクニカル指標計算
- サポート/レジスタンスレベルの算出
- AIが解釈可能な標準フォーマットへの変換

**取得データ**:

| 時間足 | 取得本数 | 主な用途 |
|--------|----------|----------|
| 日足 (D1) | 過去30本 | 長期トレンド判定、サポレジ算出 |
| 4時間足 (H4) | 過去50本 | 中期トレンド確認、EMA配列確認 |
| 1時間足 (H1) | 過去100本 | メイン分析時間軸、エントリー判定 |
| 15分足 (M15) | 過去100本 | 短期シグナル、最終エントリー判断 |

**テクニカル指標**:
- トレンド系: EMA(20, 50), MACD(12, 26, 9)
- オシレーター系: RSI(14), ストキャスティクス
- ボラティリティ系: ATR(14), ボリンジャーバンド(20, 2)
- サポート/レジスタンス: 過去20日の高値・安値、ピボットポイント、フィボナッチリトレースメント

**出力**: 標準化されたJSON形式の市場データセット

#### 2.2.2 AI分析エンジン

**役割**: 市場分析と戦略生成

**使用モデル** (全て従量課金):

| モデル | 用途 | 実行頻度 | 1回コスト |
|--------|------|----------|-----------|
| Gemini 2.5 Pro | 前日振り返り (06:00) | 1回/日 | $0.018 |
| Gemini 2.5 Pro | 朝の詳細分析 (08:00) | 1回/日 | $0.024 |
| Gemini 2.5 Flash | 定期更新 (12:00, 16:00, 21:30) | 3回/日 | $0.002×3 |
| Gemini 2.5 Flash-Lite | Layer 3a定期評価 (15分ごと) | ポジション保有時 | $0.0003 |
| Gemini 2.5 Pro | Layer 3b緊急評価 | トリガー時 | $0.018 |

**1日の合計コスト**: 約$0.07 (月$1.5、年$18)

**主要機能**:
- 市場トレンドの判定
- エントリー条件の生成
- リスク管理パラメータの決定
- 決済戦略の策定
- ポジション保有中の再評価
- 前日のトレード分析と教訓抽出

**出力**: 実行可能なルールJSON

#### 2.2.3 ルールエンジン

**役割**: 高速なルールベース判定と実行

**機能**:
- AI生成ルールの解釈と実行
- 3層監視システムの運用
- エントリー条件の継続的チェック
- 決済条件の監視と実行
- 緊急停止の即座実行

**特徴**: AIを介さない高速処理 (100ms〜5分間隔)

#### 2.2.4 データベース

**役割**: 全記録の永続化

**保存データ**:
- トレード記録 (エントリー/決済の全詳細)
- AI判断履歴 (プロンプトと応答のペア)
- ルール履歴 (日次のJSON)
- 市場データスナップショット
- バックテスト結果

**目的**:
- 分析と改善のためのデータ蓄積
- 問題発生時の追跡
- バックテストでの検証

---

## 3. 監視・安全システム

### 3.1 3層監視構造

```
┌─────────────────────────────────────────┐
│  Level 1: 保険ストップロス (MT5)         │
│  - 口座の5%                              │
│  - 最終防衛線 (システム障害時)           │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  Level 2: Layer 1監視 (100ms)            │
│  - 口座の2%で強制決済                    │
│  - ハードストップ50pips                  │
│  - スプレッド異常検知                    │
│  - フラッシュクラッシュ検知              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  Level 3: Layer 2異常検知 (1分/5分)      │
│  - サポレジブレイク                      │
│  - インジケーター反転                    │
│  - 連続逆行                              │
│  → Layer 3へエスカレーション             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  Level 4: Layer 3 AI判断                 │
│  - 定期評価 (15分) - Flash-Lite          │
│  - 緊急評価 (トリガー時) - Pro           │
│  - 柔軟な意思決定                        │
└─────────────────────────────────────────┘
```

### 3.2 Layer 1: 緊急停止 (100msごと)

**目的**: 致命的損失の即座防止

**監視項目**:

| 条件 | 検知 | 処理 |
|------|------|------|
| 口座の2%損失 | 含み損 > 口座残高 × 2% | 即座に成行決済 |
| ハードストップ | エントリーから50pips逆行 | 即座に成行決済 |
| スプレッド異常 | スプレッド > 20pips | 即座に成行決済 |
| フラッシュクラッシュ | 0.1秒で30pips以上変動 | 即座に成行決済 |

**特徴**:
- 完全にルールベース (AI不使用)
- 最高速実行 (100ms間隔)
- 確実性最優先

### 3.3 Layer 2: 異常検知 (1分 + 5分定期)

**目的**: 市場環境変化の早期発見

**1分ごとの監視**:
1. 重要レベルブレイク
2. インジケーター反転 (MACD)
3. 連続逆行 (15分足で3本連続)

**5分ごとの監視**:
4. AI避けるべき条件の発生チェック
5. RSI過熱 (>80 または <20)

**特徴**:
- ルールベースの検知
- 自動決済はしない (Layer 3に判断を委ねる)
- トリガー時は即座にエスカレーション

### 3.4 Layer 3: AI再評価

**Layer 3a: 定期評価 (15分ごと)**
- モデル: Gemini 2.5 Flash-Lite (超低コスト)
- 条件: ポジション保有中のみ
- 出力: OK/WARNING/DANGER、HOLD/CLOSE_PARTIAL/CLOSE_ALL

**Layer 3b: 緊急評価 (Layer 2トリガー時)**
- モデル: Gemini 2.5 Pro (高精度)
- 条件: Layer 2が異常検知
- 出力: 予測の妥当性、決済判断、信頼度、詳細理由

---

## 4. トレード実行システム

### 4.1 エントリー判断フロー

```
【継続的監視 (1分ごと)】

Step 1: トレード可否確認
  ↓ daily_bias が NEUTRAL → エントリーしない
  ↓ should_trade が false → エントリーしない

Step 2: 価格ゾーンチェック
  ↓ 現在価格が price_zone の範囲内か確認

Step 3: 必須シグナルチェック
  ↓ required_signals の全条件を確認

Step 4: 回避条件チェック
  ↓ avoid_if の各条件を確認

Step 5: 最終ガードレール
  ↓ スプレッド、口座残高、重要指標発表チェック

  → エントリー実行
```

### 4.2 ポジションサイズ決定

**基本ロット**: 0.1 lot

**調整倍率**: AI生成の position_size_multiplier (0.5〜1.0)

**最終ロット** = 基本ロット × 調整倍率

**調整例**:
- 確信度高い、ボラティリティ通常: 1.0倍 (0.1 lot)
- 確信度中程度: 0.7倍 (0.07 lot)
- 確信度低い、ボラティリティ高: 0.5倍 (0.05 lot)

### 4.3 ストップロス設定

**2段階の防御**:

1. **保険ストップロス (MT5に設定)**:
   - 口座の5%に相当
   - 例: 10万ドル口座、0.1 lot → 約500pips離れた位置
   - 目的: 万が一のシステム障害時の最終防衛線

2. **実質ストップロス (Layer 1で監視)**:
   - 口座の2%で強制決済
   - ハードストップ: 50pips
   - 目的: 実際の損失管理

### 4.4 決済システム

#### 4.4.1 段階的利確

**例**:
```json
[
  {"pips": 10, "close_percent": 30},
  {"pips": 20, "close_percent": 40},
  {"pips": 30, "close_percent": 100}
]
```

**実行**:
- +10pips到達: 30%決済 (残り70%)
- +20pips到達: 40%決済 (残り30%)
- +30pips到達: 全決済

#### 4.4.2 トレーリングストップ

**パラメータ例**:
```json
{
  "activate_at_pips": 15,
  "trail_percent": 50
}
```

**動作**:
- 含み益+15pips到達: トレーリング開始
- 含み益+20pips: ストップを+10pips (20 × 50%) に設定
- 含み益+30pips: ストップを+15pips (30 × 50%) に移動

**更新頻度**: 1分ごとにストップ位置を再計算

#### 4.4.3 時間管理

| ルール | 条件 | 処理 |
|--------|------|------|
| 機会損失回避 | 2時間経過 かつ ±5pips以内 | 決済実行 |
| 長時間保有 | 4時間経過 | 含み益 > 0: 全決済、含み損 > 0: 継続 (-1%以内のみ) |
| 日次クローズ | 23:00到達 | 全ポジション強制決済 |

---

## 5. データフロー

### 5.1 標準化データフォーマット

AIに渡すデータは以下の構造を持つJSON:

```json
{
  "metadata": {
    "timestamp": "2025-10-20 08:00:00",
    "symbol": "USDJPY",
    "current_price": 149.650,
    "data_hash": "abc123..."
  },

  "market_structure": {
    "daily_trend": {
      "direction": "下降",
      "strength": "中程度",
      "ema_alignment": "弱気配列",
      "recent_pattern": "レンジ形成中"
    },
    "h4_trend": { /* ... */ },
    "h1_trend": { /* ... */ },
    "m15_trend": { /* ... */ }
  },

  "technical_summary": {
    "ema": {
      "h1_ema20": 149.580,
      "h1_ema50": 149.720,
      "alignment": "弱気配列",
      "distance": "14pips差"
    },
    "rsi": { /* ... */ },
    "macd": { /* ... */ },
    "bollinger": { /* ... */ },
    "atr": { /* ... */ }
  },

  "key_levels": {
    "support": [149.50, 149.20, 149.00],
    "resistance": [149.70, 149.90, 150.20],
    "pivot": { /* ... */ }
  },

  "recent_price_action": {
    "h1_last_3": [ /* ... */ ],
    "m15_last_5": [ /* ... */ ],
    "summary": "狭いレンジ、方向感なし"
  }
}
```

### 5.2 AI出力フォーマット

```json
{
  "daily_bias": "BUY/SELL/NEUTRAL",
  "confidence": 0.75,
  "reasoning": "詳細な判断理由",

  "market_environment": {
    "trend": "上昇/下降/レンジ/転換期",
    "strength": "強い/中程度/弱い",
    "phase": "初期/中期/末期"
  },

  "entry_conditions": {
    "should_trade": true,
    "direction": "BUY/SELL",
    "price_zone": {"min": 149.50, "max": 149.70},
    "required_signals": ["具体的条件1", "具体的条件2"],
    "avoid_if": ["回避条件1", "回避条件2"]
  },

  "exit_strategy": {
    "take_profit": [
      {"pips": 10, "close_percent": 30},
      {"pips": 20, "close_percent": 40},
      {"pips": 30, "close_percent": 100}
    ],
    "stop_loss": {
      "initial": "account_2_percent",
      "trailing": {
        "activate_at_pips": 15,
        "trail_percent": 50
      }
    }
  },

  "risk_management": {
    "position_size_multiplier": 0.8,
    "max_positions": 1,
    "reason": "ボラティリティやや高め"
  }
}
```

---

## 6. 運用スケジュール

### 6.1 平日スケジュール

| 時刻 | 処理 | モデル | 1回コスト | 目的 |
|------|------|--------|---------|------|
| 06:00 | 前日振り返り | Gemini 2.5 Pro | $0.018 | 教訓抽出 |
| 08:00 | 朝の詳細分析 | Gemini 2.5 Pro | $0.024 | 市場分析、戦略生成 |
| 12:00 | 定期更新 | Gemini 2.5 Flash | $0.002 | 午前の総括 |
| 16:00 | 定期更新 | Gemini 2.5 Flash | $0.002 | 欧州前チェック |
| 21:30 | 定期更新 | Gemini 2.5 Flash | $0.002 | NY前チェック |
| 23:00 | 強制決済 | - | - | 日次クローズ |

**1日の戦略生成コスト合計**: $0.048

### 6.2 継続監視

| 監視種類 | 頻度 | 使用技術 | コスト | 目的 |
|---------|------|---------|--------|------|
| Layer 1緊急停止 | 100ms | ルールベース | $0 | 致命的損失防止 |
| エントリー監視 | 1分 | ルールベース | $0 | 条件達成チェック |
| Layer 2異常検知 | 1分/5分 | ルールベース | $0 | 環境変化検知 |
| 決済監視 | 1分 | ルールベース | $0 | 利確・損切・時間管理 |
| Layer 3a定期評価 | 15分 | Flash-Lite (従量) | 超低 | ポジション簡易チェック |
| Layer 3b緊急評価 | トリガー時 | Pro (従量) | 中 | 異常時詳細分析 |

### 6.3 週末停止

**土日の処理**:
- 新規エントリー完全停止
- Layer 1のみ稼働 (万が一のポジション監視)
- その他の処理は全停止

**金曜日23:00**: 全ポジション強制決済

**月曜日07:00**: 全機能自動復帰

---

## 7. リスク管理

### 7.1 ポジションサイズ管理

**基本方針**: 保守的なサイジング

- 基本: 0.1 lot
- 調整範囲: 0.05〜0.1 lot
- 調整要因: AI信頼度、市場ボラティリティ、口座残高

**最大ポジション数**: 1 (Phase 1-4)

### 7.2 ドローダウン管理

**最大許容ドローダウン**: 10%

**段階的対応**:

| レベル | ドローダウン | 対応 |
|--------|-------------|------|
| 警戒 | 5%到達 | ポジションサイズを50%に縮小、エントリー条件を厳格化 |
| 危険 | 7%到達 | ポジションサイズを最小 (0.05 lot) に、確信度0.8以上のみエントリー |
| 停止 | 10%到達 | 全トレード停止、徹底的な分析と改善 |

### 7.3 週次・月次チェック

**週次レビュー**:
- 損益の確認
- ドローダウンのチェック
- パフォーマンス指標の評価

**月次レビュー**:
- バックテストとの比較
- AI判断精度の推移
- システム全体の改善点抽出

---

## 8. コスト試算

### 8.1 AIコスト (Gemini API従量課金)

**1日のコスト内訳**:

| 処理 | モデル | 回数 | 入力 | 出力 | コスト |
|------|--------|------|------|------|--------|
| 前日振り返り | Pro | 1 | 2K | 1.5K | $0.0175 |
| 朝の詳細分析 | Pro | 1 | 3K | 2K | $0.02375 |
| 定期更新×3 | Flash | 3 | 1.5K×3 | 0.5K×3 | $0.0051 |
| Layer 3a定期評価 | Flash-Lite | 10 | 0.5K×10 | 0.1K×10 | $0.0009 |
| Layer 3b緊急評価 | Pro | 1 | 2K | 1.5K | $0.0175 |

**1日合計**: $0.065

**月間 (22営業日)**: $1.43

**年間 (250営業日)**: $16.25

### 8.2 総コスト試算

| 項目 | 月額 | 年額 |
|------|------|------|
| AIコスト (Gemini従量課金) | $1.43 | $16.25 |
| VPS (オプション) | $10〜30 | $120〜360 |
| **合計** | **$11〜31** | **$136〜376** |

**自宅サーバー利用時**: 月$1.43、年$16.25

---

## 9. 実装フェーズ

### Phase 1: 基礎実装 (Week 1-2)
- MT5接続とデータ取得機能
- 各時間足への変換機能
- テクニカル指標計算
- Layer 1緊急停止システム
- データベース設計と実装

### Phase 2: AI統合 (Week 3)
- Gemini API統合
- プロンプト設計と最適化
- 前日振り返り機能
- 朝の詳細分析機能
- 定期更新機能

### Phase 3: トレード実行 (Week 3-4)
- ルールエンジン実装
- エントリー監視と実行
- Layer 2異常検知
- Layer 3 AI再評価
- 決済システム

### Phase 4: バックテスト (Week 4)
- 疑似バックテスト実装
- 過去1〜3ヶ月のデータで検証
- 統計分析とレポート生成

### Phase 5: デモ運用 (Week 5-8)
- デモ口座での実運用開始
- 最小ロット (0.01 lot) から開始
- プロンプトの継続的改善

### Phase 6: 本番運用 (Week 9-)
- 実資金での運用開始
- ロットサイズの段階的増加
- 継続的な最適化

---

## 10. 成功指標 (KPI)

### 10.1 技術指標

- システム稼働率: 99%以上
- データ取得成功率: 99.5%以上
- AI応答時間: 平均5秒以内
- 緊急停止応答時間: 100ms以内

### 10.2 パフォーマンス指標

- 月次勝率: 60%以上
- プロフィットファクター: 1.5以上
- 最大ドローダウン: 10%以下
- リスクリワード比: 1:2以上

### 10.3 AI精度指標

- 方向性的中率: 65%以上
- 判断の一貫性: 90%以上
- エントリー判断妥当性: 70%以上

---

## まとめ

本システムは、**3層アーキテクチャ**と**多層防御**により、安全で再現可能なFX自動トレードを実現します。

**主な特徴**:
1. データ処理、AI判断、高速実行の明確な分離
2. 100msの緊急停止から15分のAI再評価まで、多段階の監視システム
3. Gemini API従量課金による超低コスト運用 (月$1.43)
4. 完全なデータ記録による再現性と継続的改善
5. 段階的実装による安全な開発と検証

このアーキテクチャにより、柔軟性と安全性を両立した自動トレードシステムを構築します。

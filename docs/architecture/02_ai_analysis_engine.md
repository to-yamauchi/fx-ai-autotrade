# AI分析エンジン仕様書

## ドキュメント情報
- **作成日**: 2025-10-21
- **バージョン**: 1.0
- **カテゴリ**: システムアーキテクチャ - AI判断層

---

## 1. 概要

### 1.1 役割

市場データを分析し、トレード戦略を生成するAI駆動のコンポーネント

### 1.2 位置づけ

```
データ処理エンジン → 【AI分析エンジン】 → ルールエンジン
```

### 1.3 設計原則

- **再現性**: 低温度パラメータ（0.3）で同じ入力から同じ判断
- **柔軟性**: 市場環境の変化に適応して戦略を日々更新
- **学習**: 前日の振り返りから教訓を抽出し改善
- **コスト効率**: 従量課金で月$1.43（年$16）の超低コスト

---

## 2. AIモデル構成

### 2.1 使用モデル（Gemini API統一）

#### 2.1.1 モデル選択基準

| モデル | 用途 | 使用頻度 | 1回コスト | 特徴 |
|--------|------|---------|----------|------|
| **Gemini 2.5 Pro** | 前日振り返り（06:00）<br>朝の詳細分析（08:00）<br>Layer 3b緊急評価 | 3回/日 | $0.018〜0.024 | 高精度・詳細分析 |
| **Gemini 2.5 Flash** | 定期更新（12:00, 16:00, 21:30） | 3回/日 | $0.002 | 中精度・高速 |
| **Gemini 2.5 Flash-Lite** | Layer 3a定期評価（15分ごと） | 平均10回/日 | $0.0003 | 超低コスト・超高速 |

**1日の合計コスト**: 約$0.065（月$1.43、年$16.25）

#### 2.1.2 Gemini従量課金で統一する理由

**コスト比較**:
- サブスク型（Claude Pro等）: $60〜100/月
- Gemini従量課金: $1.43/月
- **削減率**: 95%以上

**メリット**:
1. 圧倒的な低コスト
2. 単一API管理でシンプル
3. 必要に応じてモデルを使い分け
4. 使った分だけ課金で無駄なし

### 2.2 パラメータ設定

#### 2.2.1 再現性の確保

```python
# 全モデル共通設定
temperature = 0.3  # 低温度で一貫性重視
top_p = 0.95
max_tokens = 2000  # Pro/Flash
max_tokens = 100   # Flash-Lite
```

**目的**:
- 同じ市場データから同じ判断を生成
- バックテストでの再現性確保
- 判断の一貫性維持

---

## 3. 分析の種類と頻度

### 3.1 前日振り返り（06:00）

#### 3.1.1 概要

**使用モデル**: Gemini 2.5 Pro（従量課金）
**1回コスト**: $0.018
**目的**: 構造化された振り返りと改善点抽出

#### 3.1.2 入力データ

```json
{
  "trades": [
    {
      "entry_time": "2025-10-20 10:30:00",
      "exit_time": "2025-10-20 14:15:00",
      "direction": "BUY",
      "entry_price": 149.60,
      "exit_price": 149.75,
      "pips": 15,
      "profit_loss": "$75",
      "exit_reason": "take_profit_level_2"
    }
  ],
  "predictions": {
    "daily_bias": "BUY",
    "confidence": 0.75,
    "reasoning": "..."
  },
  "actual_market": {
    "high": 149.85,
    "low": 149.45,
    "close": 149.72,
    "direction": "上昇",
    "volatility": "中程度"
  },
  "statistics": {
    "total_pips": 15,
    "win_rate": "100%",
    "max_drawdown": "-5pips"
  }
}
```

#### 3.1.3 出力フォーマット

```json
{
  "score": {
    "direction": "35/40点",
    "entry_timing": "16/20点",
    "exit_timing": "18/20点",
    "risk_management": "19/20点",
    "total": "88/100点"
  },

  "analysis": {
    "what_worked": [
      "BUY予測が的中、方向性判断が正確",
      "段階的利確で利益を確実に確保",
      "エントリータイミングは良好"
    ],
    "what_failed": [
      "最大+25pipsまで伸びたが+20pipsで全決済、伸ばしきれず"
    ],
    "missed_signals": [
      "14:00のEMAゴールデンクロスで追加エントリーの機会があった"
    ]
  },

  "lessons_for_today": [
    "教訓1: レンジ相場では早めの利確が有効 → 今日もレンジ気配なら+15pipsで50%決済",
    "教訓2: トレンドが明確な場合はトレーリングストップを早めに発動",
    "教訓3: EMAクロスは信頼できるシグナルとして活用"
  ],

  "pattern_recognition": {
    "success_patterns": [
      "EMA配列確認後のエントリーは勝率高い",
      "欧州市場開始前のポジション整理が有効"
    ],
    "failure_patterns": [
      "東京時間の小動きでの早期エントリーは避けるべき"
    ]
  }
}
```

### 3.2 朝の詳細分析（08:00）

#### 3.2.1 概要

**使用モデル**: Gemini 2.5 Pro（従量課金）
**1回コスト**: $0.024
**目的**: 市場分析と本日の戦略生成

#### 3.2.2 入力データ

- 標準化された市場データ（データ処理エンジンから）
- 前日の振り返り結果
- 過去5日の統計

#### 3.2.3 プロンプト構造

```
あなたはプロのFXトレーダーです。以下の市場データを分析し、本日のUSDJPYトレード戦略を策定してください。

## 市場データ
{標準化データJSON}

## 前日の振り返り
{振り返りJSON}

## 分析指示
1. 市場環境の総合判断（トレンド、強度、フェーズ）
2. 本日のバイアス（BUY/SELL/NEUTRAL）と信頼度
3. エントリー条件の具体的生成
4. リスク管理パラメータの設定
5. 決済戦略の策定
6. 前日の教訓の適用

## 出力フォーマット
以下のJSON形式で出力してください:
{出力フォーマット}

## 重要な制約
- 再現性重視: 同じデータなら同じ判断を
- 具体性重視: 「価格がXXXを超えたら」等、明確な条件を
- リスク優先: 不確実な時はNEUTRALまたは保守的な判断を
```

#### 3.2.4 出力フォーマット

```json
{
  "daily_bias": "BUY",
  "confidence": 0.75,
  "reasoning": "H1足でEMA20>EMA50の強気配列が継続。RSI 45と中立圏だが、MACDがゴールデンクロス間近。日足は下降トレンドだが、短期的な反発の可能性。149.50のサポートが機能しており、ここからの反発狙い。",

  "market_environment": {
    "trend": "短期反発の可能性（日足は下降トレンド中）",
    "strength": "中程度",
    "phase": "サポート付近での反発初期"
  },

  "entry_conditions": {
    "should_trade": true,
    "direction": "BUY",
    "price_zone": {
      "min": 149.50,
      "max": 149.65
    },
    "required_signals": [
      "現在価格が149.50〜149.65の範囲内",
      "M15足でEMA20を上抜け",
      "RSI > 50",
      "MACDがゴールデンクロス済み、またはヒストグラムが正",
      "スプレッド < 10pips"
    ],
    "avoid_if": [
      "現在価格が149.50を明確に下抜け（5pips以上）",
      "スプレッド > 10pips",
      "RSI > 70（買われすぎ）",
      "重要指標発表30分以内"
    ]
  },

  "exit_strategy": {
    "take_profit": [
      {"pips": 10, "close_percent": 30, "reason": "早期利益確保"},
      {"pips": 20, "close_percent": 40, "reason": "主要利益確定"},
      {"pips": 30, "close_percent": 100, "reason": "目標達成"}
    ],
    "stop_loss": {
      "initial": "account_2_percent",
      "price_level": 149.40,
      "trailing": {
        "activate_at_pips": 15,
        "trail_percent": 50,
        "comment": "+15pips到達で利益の50%を保護"
      }
    },
    "indicator_exits": [
      {
        "condition": "MACDデッドクロス",
        "action": "CLOSE_50",
        "reason": "モメンタム低下の兆候"
      },
      {
        "condition": "M15足でEMA20を明確に下抜け（2本連続で下）",
        "action": "CLOSE_ALL",
        "reason": "短期トレンド転換"
      }
    ],
    "time_exits": {
      "max_hold_minutes": 240,
      "reason": "4時間以内の短期トレード",
      "force_close_time": "23:00"
    }
  },

  "risk_management": {
    "position_size_multiplier": 0.8,
    "max_positions": 1,
    "reason": "信頼度0.75だが、日足は下降トレンドのため保守的に"
  },

  "key_levels": {
    "entry_target": 149.55,
    "invalidation_level": 149.40,
    "critical_support": 149.50,
    "critical_resistance": 149.70,
    "comment": "149.50割れたらシナリオ崩壊、撤退"
  },

  "scenario_planning": {
    "bullish_scenario": "149.70抜けたら149.90、150.00を目指す展開。確率30%",
    "bearish_scenario": "149.50割れたら149.20、149.00まで下落の可能性。確率30%",
    "base_case": "149.50〜149.70のレンジ継続、小幅な上下動。確率40%"
  },

  "lessons_applied": [
    "昨日の教訓: レンジ時の早期利確 → 今日: +15pipsで50%決済（修正: +10pipsで30%、+20pipsで40%）",
    "昨日の成功: EMAクロス後のエントリー → 今日: required_signalsに明記"
  ]
}
```

### 3.3 定期更新（12:00, 16:00, 21:30）

#### 3.3.1 概要

**使用モデル**: Gemini 2.5 Flash（従量課金）
**1回コスト**: $0.002
**目的**: 朝の予測の妥当性確認と必要に応じた修正

#### 3.3.2 入力データ

- 朝の予測内容
- 更新時刻までの実際の動き
- 現在の市場状況

#### 3.3.3 出力フォーマット

```json
{
  "prediction_status": "有効",
  "confidence_update": 0.70,
  "reasoning": "午前中は予想通り149.50〜149.65のレンジで推移。ボラティリティやや低下。予測は継続有効だが、信頼度をやや下げる。",
  "action": "継続",

  "observations": [
    "149.55でサポートされ、2度反発",
    "出来高が減少傾向、様子見ムード",
    "欧州市場開始前で動き鈍い"
  ],

  "rule_updates": null
}
```

**修正が必要な場合の例**:
```json
{
  "prediction_status": "要修正",
  "confidence_update": 0.50,
  "reasoning": "149.50を明確に下抜け、当初のサポートが機能せず。下降圧力が予想より強い。",
  "action": "修正",

  "rule_updates": {
    "daily_bias": "NEUTRAL",
    "entry_conditions": {
      "should_trade": false,
      "reason": "シナリオ崩壊、様子見"
    }
  }
}
```

### 3.4 ポジション監視

#### 3.4.1 Layer 3a: 定期評価（15分ごと）

**使用モデル**: Gemini 2.5 Flash-Lite（従量課金）
**1回コスト**: $0.0003
**条件**: ポジション保有中のみ

**プロンプト最適化**:
- 入力: 最大500トークン（極限まで圧縮）
- 出力: 最大100トークン（JSON形式のみ）
- 応答時間: 1秒以内

**入力データ（圧縮形式）**:
```json
{
  "pos": "BUY@149.55,45min,+8p",
  "now": "149.63",
  "plan": "149.70抜け期待",
  "m15": ["↑","↑","→"],
  "rsi": "55→58↑",
  "macd": "0.008>0.005"
}
```

**出力フォーマット**:
```json
{
  "s": "OK",
  "a": "HOLD",
  "r": "on track"
}
```

**ステータス定義**:
- OK: 予想通りの動き
- WARNING: やや懸念あり
- DANGER: 要注意、Layer 3bへエスカレーション

#### 3.4.2 Layer 3b: 緊急評価（Layer 2トリガー時）

**使用モデル**: Gemini 2.5 Pro（従量課金）
**1回コスト**: $0.018
**条件**: Layer 2が異常検知した時

**入力データ**:
- ポジション全情報
- 過去1時間の価格推移
- 全インジケーター値
- トリガー理由（例: critical_support割れ）
- 元の予測内容

**出力フォーマット**:
```json
{
  "prediction_validity": "PARTIALLY_INVALID",
  "decision": "CLOSE_50",
  "confidence": 0.80,
  "reasoning": "149.50のcritical_supportを下抜け。当初のシナリオは崩れた。ただし、直下の149.45で一時的にサポートされている可能性もあり、全決済ではなく50%決済を推奨。残り50%は149.45割れで損切り。",
  "urgency": "MEDIUM",
  "stop_loss_adjustment": 149.43,
  "alternative_plan": "149.40で明確にサポートされたらSELLポジション検討"
}
```

**緊急度定義**:
- LOW: 経過観察
- MEDIUM: 部分決済または調整
- HIGH: 即座に全決済

---

## 4. 多角的分析オプション

### 4.1 オプションA: 朝の分析で複数視点（高精度）

**概要**: 異なるプロンプトで3回実行して比較

**プロンプト3種**:

1. **テクニカル重視**:
   - チャートパターン分析
   - テクニカル指標の詳細評価
   - 価格アクションの解釈

2. **リスク管理重視**:
   - 市場環境の構造化評価
   - エントリー/決済ルールの論理的構築
   - 最悪シナリオの分析

3. **トレンド重視**:
   - 大局的なトレンド判定
   - 市場心理の解釈
   - セッション別の傾向分析

**統合処理**:
```python
# 3つの出力を比較
results = [technical_output, risk_output, trend_output]

# 一致度評価
bias_votes = [r['daily_bias'] for r in results]
if bias_votes.count(bias_votes[0]) == 3:
    # 3つとも一致 → 高信頼度
    final_bias = bias_votes[0]
    final_confidence = max(r['confidence'] for r in results)
elif bias_votes.count(bias_votes[0]) == 2:
    # 2つ一致 → 中信頼度
    final_bias = bias_votes[0]
    final_confidence = 0.60
else:
    # 全て不一致 → 保守的判断
    final_bias = "NEUTRAL"
    final_confidence = 0.30

# 最も保守的な条件を採用
final_entry_conditions = merge_conservative(results)
```

**コスト**: $0.024 × 3 = $0.072/日（月$1.58追加、合計$2.48/月）

### 4.2 オプションB: 単一実行（推奨）

**概要**: Gemini Pro 1回のみ、包括的なプロンプト

**メリット**:
- コスト削減（月$1.43）
- シンプルな処理
- 十分な精度

**推奨**: Phase 1-4はオプションBで開始、必要に応じてオプションAへ

---

## 5. 再現性の確保

### 5.1 プロンプト管理

**記録内容**:
- 使用したプロンプトテキスト
- プロンプトバージョン番号
- 実行時刻
- 入力データハッシュ

**バージョン管理**:
```python
prompt_version = "v1.2.3"
prompt_template = load_prompt(prompt_version)
```

### 5.2 実行記録

**データベース保存**:
```sql
CREATE TABLE ai_judgments (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP,
    judgment_type VARCHAR(50),  -- 'morning_analysis', 'review', etc.
    model_name VARCHAR(50),
    prompt_version VARCHAR(20),
    input_data_hash VARCHAR(64),
    input_tokens INT,
    output_tokens INT,
    cost_usd DECIMAL(10, 6),
    temperature DECIMAL(3, 2),
    response_json JSONB,
    execution_time_ms INT
);
```

### 5.3 バックテストでの再現

**プロセス**:
1. 過去の特定日のdata_hashを取得
2. 同じデータを再構築
3. 同じprompt_versionを使用
4. temperature=0.3で実行
5. 複数回実行して一貫性確認

---

## 6. パフォーマンス要件

### 6.1 応答時間

| 分析タイプ | 目標応答時間 | 許容最大時間 |
|-----------|-------------|-------------|
| 前日振り返り | 5秒 | 10秒 |
| 朝の詳細分析 | 8秒 | 15秒 |
| 定期更新 | 3秒 | 8秒 |
| Layer 3a定期評価 | 1秒 | 3秒 |
| Layer 3b緊急評価 | 5秒 | 10秒 |

### 6.2 精度指標（Phase 4バックテストで評価）

- **方向性的中率**: 65%以上
- **判断の一貫性**: 90%以上（3回実行で同じ結果）
- **エントリー判断妥当性**: 70%以上

---

## 7. エラーハンドリング

### 7.1 API呼び出しエラー

**対応**:
1. 3回まで再試行（指数バックオフ: 2秒、4秒、8秒）
2. 失敗時は直前の判断を継続使用
3. アラート送信

### 7.2 不正なJSON出力

**対応**:
1. JSONパース試行
2. 失敗時はAI再実行（修正指示付き）
3. 2回失敗したら保守的なデフォルト判断使用

### 7.3 コスト超過

**監視**:
- 日次コスト上限: $0.20
- 月次コスト上限: $5.00

**超過時**:
- Layer 3a頻度を30分に延長
- アラート送信
- 管理者確認まで一時停止

---

## 8. 実装ロードマップ

### Phase 2（Week 3）

**優先度: 最高**

- Gemini API統合
- プロンプト設計（全タイプ）
- 前日振り返り機能
- 朝の詳細分析機能
- 定期更新機能
- ルールJSON生成

### Phase 3（Week 3-4）

**優先度: 高**

- Layer 3a/3b実装
- エラーハンドリング
- コスト監視
- プロンプトバージョン管理

### Phase 4（Week 4）

**優先度: 高**

- バックテストでの検証
- プロンプト最適化
- 再現性確認

### Phase 5（Week 5-8）

**優先度: 中**

- デモ運用での調整
- プロンプト継続改善

---

## 9. コスト試算詳細

### 9.1 基本プラン（月$1.43）

| 処理 | モデル | 回数/日 | 入力 | 出力 | 日次コスト |
|------|--------|---------|------|------|-----------|
| 前日振り返り | Pro | 1 | 2K | 1.5K | $0.0175 |
| 朝の詳細分析 | Pro | 1 | 3K | 2K | $0.02375 |
| 定期更新 | Flash | 3 | 1.5K | 0.5K | $0.0051 |
| Layer 3a | Flash-Lite | 10 | 0.5K | 0.1K | $0.0009 |
| Layer 3b | Pro | 1 | 2K | 1.5K | $0.0175 |

**日次**: $0.065
**月次（22営業日）**: $1.43

### 9.2 多角的分析オプション（月$2.48）

追加コスト: $0.024 × 2回 = $0.048/日（月$1.06追加）

---

**以上、AI分析エンジン仕様書**

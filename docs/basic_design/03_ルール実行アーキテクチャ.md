# ルール実行アーキテクチャ（基本設計）

## ドキュメント情報
- **作成日**: 2025-10-21
- **バージョン**: 1.0
- **種別**: 基本設計書
- **対応する詳細設計**: [03_rule_engine.md](../architecture/03_rule_engine.md)

---

## 1. 概要

### 1.1 役割

AI生成ルールを高速に実行し、エントリー・決済を機械的に判定・実行するアーキテクチャ

### 1.2 位置づけ

```
AI分析層 → [ルール実行層] → MT5実行
              ↓
         3層監視システム
```

ルール実行層は、AIを介さない高速処理で安全性と即応性を確保する

---

## 2. アーキテクチャ構成

### 2.1 全体像

```
┌─────────────────────────────────────────┐
│        ルール実行アーキテクチャ            │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ AI生成ルールの管理                │   │
│  │  - ルールJSONの読み込み           │   │
│  │  - ルールの解釈                   │   │
│  │  - ルールの更新                   │   │
│  └─────────────────────────────────┘   │
│            ↓                            │
│  ┌─────────────────────────────────┐   │
│  │ エントリー監視 (1分ごと)          │   │
│  │  - 条件チェック                   │   │
│  │  - ガードレール確認               │   │
│  │  - MT5注文実行                   │   │
│  └─────────────────────────────────┘   │
│            ↓                            │
│  ┌─────────────────────────────────┐   │
│  │ 3層監視システム                   │   │
│  │                                   │   │
│  │  [Layer 1] 緊急停止 (100ms)      │   │
│  │    - 口座2%損失                  │   │
│  │    - ハードストップ50pips         │   │
│  │    - スプレッド異常               │   │
│  │    - フラッシュクラッシュ          │   │
│  │    → 即座に決済                  │   │
│  │                                   │   │
│  │  [Layer 2] 異常検知 (1分/5分)    │   │
│  │    - サポレジブレイク             │   │
│  │    - 指標反転                    │   │
│  │    - 連続逆行                    │   │
│  │    → Layer 3へエスカレーション    │   │
│  │                                   │   │
│  │  [Layer 3] AI再評価              │   │
│  │    - 定期評価 (15分)             │   │
│  │    - 緊急評価 (トリガー時)        │   │
│  │    → 決済判断                    │   │
│  │                                   │   │
│  └─────────────────────────────────┘   │
│            ↓                            │
│  ┌─────────────────────────────────┐   │
│  │ 決済監視 (1分ごと)                │   │
│  │  - 利確レベル監視                 │   │
│  │  - トレーリングストップ更新        │   │
│  │  - 時間管理                      │   │
│  │  - MT5決済実行                   │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 2.2 コンポーネント階層

| レベル | コンポーネント | 頻度 | 技術 | 目的 |
|-------|--------------|------|------|------|
| **最高速** | Layer 1緊急停止 | 100ms | ルールベース | 致命的損失防止 |
| **高速** | エントリー監視 | 1分 | ルールベース | 条件チェック |
| | Layer 2異常検知 | 1分/5分 | ルールベース | 環境変化検知 |
| | 決済監視 | 1分 | ルールベース | 利確・損切 |
| **中速** | Layer 3定期 | 15分 | AI再評価 | 継続監視 |
| **可変** | Layer 3緊急 | トリガー時 | AI再評価 | 異常時判断 |

---

## 3. 主要コンポーネント

### 3.1 ルール管理

**責務**: AI生成ルールの管理と解釈

**機能**:
- ルールJSONの読み込み
- ルール有効性の確認
- ルール更新の反映
- 複数バージョンの管理

**処理フロー**:
```
AI分析完了
  ↓
新ルールJSON生成
  ↓
ルール検証 (JSON構造チェック)
  ↓
現在ルールと比較
  ↓
ルール更新 (必要時)
  ↓
エントリー/決済監視へ反映
```

### 3.2 エントリー監視

**責務**: エントリー条件の継続的チェックと実行

**監視頻度**: 1分ごと

**判定フロー**:
```
Step 1: トレード可否
  ├→ daily_bias == NEUTRAL → 見送り
  └→ should_trade == false → 見送り

Step 2: 価格ゾーン
  ├→ 現在価格が price_zone 範囲内か
  └→ 範囲外 → 待機

Step 3: 必須シグナル
  ├→ required_signals 全条件確認
  └→ 1つでも未達 → 待機

Step 4: 回避条件
  ├→ avoid_if 条件確認
  └→ 1つでも該当 → 見送り

Step 5: ガードレール
  ├→ スプレッド > 10pips → 見送り
  ├→ 口座残高不足 → 見送り
  └→ 重要指標30分以内 → 見送り

全クリア → エントリー実行
```

### 3.3 Layer 1: 緊急停止

**責務**: 致命的損失の即座防止

**監視頻度**: 100msごと

**緊急条件**:

| 条件 | 検知基準 | 処理 |
|------|---------|------|
| **口座2%損失** | 含み損 > 口座残高 × 2% | 即座に成行決済 |
| **ハードストップ** | エントリーから50pips逆行 | 即座に成行決済 |
| **スプレッド異常** | スプレッド > 20pips | 即座に成行決済 |
| **フラッシュクラッシュ** | 0.1秒で30pips以上変動 | 即座に成行決済 |

**特徴**:
- 完全にルールベース（AI不使用）
- 最高速実行（100ms間隔）
- 確実性最優先
- 独立稼働（他システム障害時も動作）

### 3.4 Layer 2: 異常検知

**責務**: 市場環境変化の早期発見

**監視頻度**: 1分 + 5分定期

**検知条件**:

| 頻度 | 監視項目 | トリガー条件 | 処理 |
|-----|---------|-------------|------|
| **1分** | 重要レベルブレイク | critical_support割れ / critical_resistance抜け | Layer 3へ |
| | インジケーター反転 | MACDクロス等 | Layer 3へ |
| | 連続逆行 | 15分足で3本連続逆方向 | Layer 3へ |
| **5分** | 回避条件発生 | avoid_if 条件該当 | Layer 3へ |
| | RSI過熱 | RSI > 80 or < 20 | Layer 3へ |

**特徴**:
- ルールベースの検知
- 自動決済はしない
- 即座にLayer 3へエスカレーション

### 3.5 Layer 3: AI再評価

**責務**: 異常時の柔軟な判断

**2つのモード**:

#### Layer 3a: 定期評価 (15分)
- 条件: ポジション保有中
- モデル: Gemini Flash-Lite
- 処理: 簡易チェック
- 出力: OK/WARNING/DANGER

#### Layer 3b: 緊急評価 (トリガー時)
- 条件: Layer 2が異常検知
- モデル: Gemini Pro
- 処理: 詳細分析
- 出力: 決済判断 (保持/部分/全決済)

**特徴**:
- AI判断による柔軟性
- 緊急度に応じた処理
- ストップロス調整機能

### 3.6 決済監視

**責務**: ポジションの継続監視と決済実行

**監視頻度**: 1分ごと

**監視項目**:

| 項目 | 処理 |
|------|------|
| **段階的利確** | take_profit ルールに従って部分決済 |
| **トレーリングストップ** | 含み益に応じてストップ位置を更新 |
| **インジケーター決済** | indicator_exits 条件に従って決済 |
| **時間管理** | 最大保有時間、23:00強制決済 |

---

## 4. データフロー

### 4.1 エントリー実行フロー

```
ルールJSON読み込み
  ↓
1分ごとの監視ループ
  ├→ 現在価格取得
  ├→ エントリー条件チェック
  │   (Step 1〜5)
  ├→ 全条件クリア
  └→ エントリー実行
      ├→ ポジションサイズ計算
      ├→ MT5注文送信
      ├→ 保険ストップロス設定 (口座5%)
      ├→ トレード記録 (DB)
      └→ 監視モードへ移行
```

### 4.2 監視・決済フロー

```
ポジション保有中

100msごと - Layer 1
  ├→ 緊急条件チェック
  └→ 該当 → 即決済

1分ごと - Layer 2
  ├→ 異常条件チェック
  └→ 該当 → Layer 3bへ

15分ごと - Layer 3a
  ├→ AI簡易評価
  ├→ DANGER判定 → Layer 3bへ
  └→ 決済指示 → 実行

Layer 2トリガー - Layer 3b
  ├→ AI詳細評価
  └→ 決済判断 → 実行

1分ごと - 決済監視
  ├→ 利確レベル到達 → 部分/全決済
  ├→ トレーリングストップ更新
  └→ 時間管理 → 必要時決済
```

---

## 5. 設計原則

### 5.1 高速性

**原則**: AIを介さない即座の実行

**実現方法**:
- Layer 1の100ms監視
- エントリー/決済監視の1分間隔
- ルールベースの機械的判定

**目的**:
- 緊急時の即応性
- 市場変化への迅速な対応

### 5.2 安全性

**原則**: 多層防御による口座保護

**実現方法**:
- 4層の防御システム
  1. 保険ストップロス (MT5設定)
  2. Layer 1緊急停止
  3. Layer 2異常検知
  4. Layer 3 AI再評価

**目的**:
- 致命的損失の防止
- システム障害時の保護

### 5.3 確実性

**原則**: 曖昧さのない機械的判定

**実現方法**:
- ルールの明確化
- 条件の具体化
- エラーハンドリング

**目的**:
- 予期しない動作の防止
- デバッグの容易性

---

## 6. ポジションサイズ計算

### 6.1 基本ロジック

```
基本ロット = 0.1 lot

調整倍率 = AI生成の position_size_multiplier (0.5〜1.0)

最終ロット = 基本ロット × 調整倍率
```

### 6.2 調整例

| シナリオ | 倍率 | 最終ロット |
|---------|------|-----------|
| 確信度高、ボラティリティ通常 | 1.0 | 0.1 lot |
| 確信度中程度 | 0.7 | 0.07 lot |
| 確信度低、ボラティリティ高 | 0.5 | 0.05 lot |

---

## 7. ストップロス管理

### 7.1 2段階の防御

**保険ストップロス（MT5設定）**:
- 口座の5%に相当
- 万が一のシステム障害時の最終防衛線
- 例: 10万ドル口座、0.1 lot → 約500pips

**実質ストップロス（Layer 1監視）**:
- 口座の2%で強制決済
- ハードストップ: 50pips
- 実際の損失管理

### 7.2 動的調整

**トレーリングストップ**:
- 含み益が一定水準を超えたら発動
- 利益を守りつつ伸ばす機会も維持
- 1分ごとにストップ位置を再計算

---

## 8. パフォーマンス要件

### 8.1 処理速度目標

| 処理 | 目標時間 | 重要度 |
|------|---------|--------|
| **Layer 1緊急停止** | 100ms以内 | 最高 |
| **エントリー判断** | 1秒以内 | 高 |
| **決済判断** | 1秒以内 | 高 |
| **Layer 2検知** | 1秒以内 | 高 |

### 8.2 信頼性目標

| 指標 | 目標値 |
|------|--------|
| **Layer 1稼働率** | 99.9%以上 |
| **エントリー実行成功率** | 99%以上 |
| **決済実行成功率** | 99.5%以上 |

---

## 9. エラーハンドリング

### 9.1 MT5注文エラー

**対応フロー**:
```
注文送信
  ↓ エラー
エラー種別判定
  ├→ 一時的エラー (サーバービジー等)
  │   └→ 3回まで再試行 (1秒間隔)
  └→ 永続的エラー (残高不足等)
      └→ エラー記録、アラート送信
```

### 9.2 Layer 1障害

**対応**:
- Layer 1は独立したプロセスで稼働
- 他システムの障害の影響を受けない
- 万が一の停止時は保険ストップロス (MT5設定) が機能

### 9.3 ルール不整合

**検証項目**:
- JSON構造の妥当性
- 必須フィールドの存在
- 数値範囲の正当性

**対応**:
```
ルール検証エラー
  ↓
直前の有効なルールを継続使用
アラート送信
AI再実行を要請
```

---

## 10. まとめ

### 10.1 アーキテクチャの特徴

1. **高速実行**: AI判断を待たない100ms〜1分間隔の処理
2. **多層防御**: 4層の安全装置による口座保護
3. **機械的判定**: ルールベースの確実な実行
4. **柔軟な再評価**: Layer 3でのAI判断
5. **独立稼働**: Layer 1の完全独立動作

### 10.2 安全性の要

ルール実行層は、システム全体の安全性を担保する最重要層:
- 緊急時の即座対応
- 致命的損失の防止
- システム障害時の保護継続

### 10.3 次のステップ

詳細な実装仕様については、以下を参照:
- [詳細設計書: ルールエンジン](../architecture/03_rule_engine.md)
- [詳細設計書: トレード実行システム](../architecture/07_trade_execution_system.md)
- [詳細設計書: 監視・決済システム](../architecture/05_monitoring_settlement_system.md)

---

**本書は基本設計レベルのアーキテクチャを示しています。**
**実装の詳細は詳細設計書を参照してください。**

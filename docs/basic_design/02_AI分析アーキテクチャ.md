# AI分析アーキテクチャ（基本設計）

## ドキュメント情報
- **作成日**: 2025-10-21
- **バージョン**: 1.0
- **種別**: 基本設計書
- **対応する詳細設計**: [02_ai_analysis_engine.md](../architecture/02_ai_analysis_engine.md)

---

## 1. 概要

### 1.1 役割

市場データを分析し、実行可能なトレード戦略を生成するAI駆動のアーキテクチャ

### 1.2 位置づけ

```
データ処理層 → [AI分析層] → ルール実行層
```

AI分析層は、標準化されたデータを受け取り、人間が読める戦略と機械が実行できるルールを生成する

---

## 2. アーキテクチャ構成

### 2.1 全体像

```
┌─────────────────────────────────────────┐
│          AI分析アーキテクチャ             │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  前日振り返り (06:00)            │   │
│  │  - トレード結果分析              │   │
│  │  - 成功・失敗要因の抽出           │   │
│  │  - 教訓の生成                    │   │
│  │  [Gemini 2.5 Pro]               │   │
│  └─────────────────────────────────┘   │
│            ↓ 教訓                       │
│  ┌─────────────────────────────────┐   │
│  │  朝の詳細分析 (08:00)            │   │
│  │  - 市場環境の総合判断             │   │
│  │  - トレードバイアスの決定          │   │
│  │  - エントリー条件の生成           │   │
│  │  - リスク管理パラメータ設定        │   │
│  │  [Gemini 2.5 Pro]               │   │
│  └─────────────────────────────────┘   │
│            ↓ ルールJSON                 │
│  ┌─────────────────────────────────┐   │
│  │  定期更新 (12:00, 16:00, 21:30)  │   │
│  │  - 予測の妥当性確認              │   │
│  │  - 必要に応じた修正              │   │
│  │  [Gemini 2.5 Flash]             │   │
│  └─────────────────────────────────┘   │
│            ↓                            │
│  ┌─────────────────────────────────┐   │
│  │  ポジション監視                   │   │
│  │  - Layer 3a: 定期評価 (15分)     │   │
│  │    [Gemini Flash-Lite]          │   │
│  │  - Layer 3b: 緊急評価            │   │
│  │    [Gemini Pro]                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 2.2 AI分析の階層構造

| 層 | 分析タイプ | 頻度 | モデル | 目的 |
|----|----------|------|--------|------|
| **戦略層** | 前日振り返り | 1回/日 | Pro | 学習 |
| | 朝の詳細分析 | 1回/日 | Pro | 戦略生成 |
| **調整層** | 定期更新 | 3回/日 | Flash | 戦略修正 |
| **監視層** | 定期評価 | 15分/回 | Flash-Lite | 簡易チェック |
| | 緊急評価 | トリガー時 | Pro | 詳細判断 |

---

## 3. 主要コンポーネント

### 3.1 前日振り返り分析

**目的**: 過去のトレードから教訓を抽出

**入力**:
- 前日のトレード記録
- AI予測内容
- 実際の市場動向

**出力**:
- 100点満点のスコアリング
- 成功・失敗要因の分析
- 本日への教訓

**特徴**:
- 構造化された評価
- 定量的・定性的分析の組み合わせ
- パターン認識

### 3.2 朝の詳細分析

**目的**: 本日のトレード戦略を生成

**入力**:
- 標準化された市場データ
- 前日の振り返り結果
- 過去5日の統計

**出力**:
- トレードバイアス (BUY/SELL/NEUTRAL)
- 信頼度スコア
- エントリー条件 (具体的)
- 決済戦略 (利確・損切)
- リスク管理パラメータ

**特徴**:
- 最も重要な分析
- 1日の戦略の基礎
- 詳細かつ実行可能なルール生成

### 3.3 定期更新

**目的**: 朝の予測の妥当性を確認

**実行タイミング**:
- 12:00 (午前の総括)
- 16:00 (欧州市場前)
- 21:30 (NY市場前)

**処理**:
- 予測と実際の動きを比較
- 重要な変化の検知
- 必要に応じてルール修正

**特徴**:
- 軽量・高速 (Flash使用)
- 予測の継続性維持
- 大きな環境変化への対応

### 3.4 ポジション監視 (Layer 3)

#### Layer 3a: 定期評価

**頻度**: 15分ごと (ポジション保有時のみ)

**目的**: 超高速・低コストの簡易チェック

**処理**:
- 予想通りの動きか確認
- 異常の早期発見
- 必要に応じてLayer 3bへエスカレーション

**特徴**:
- 極限まで圧縮したプロンプト
- 1秒以内の応答
- 超低コスト (Flash-Lite)

#### Layer 3b: 緊急評価

**トリガー**: Layer 2が異常検知

**目的**: 詳細分析で的確な判断

**処理**:
- 予測の妥当性を再評価
- 決済判断 (保持/部分決済/全決済)
- ストップロス調整

**特徴**:
- 高精度分析 (Pro使用)
- 緊急度評価
- 代替プランの提示

---

## 4. データフロー

### 4.1 日次戦略生成フロー

```
05:59 - システム起動

06:00 - 前日振り返り
  ├→ DB: 前日トレード記録取得
  ├→ AI: Gemini Pro で分析
  ├→ 出力: スコア、教訓
  └→ DB: 振り返り結果保存

08:00 - 朝の詳細分析
  ├→ データ処理層: 市場データ取得
  ├→ DB: 前日の教訓取得
  ├→ AI: Gemini Pro で戦略生成
  ├→ 出力: ルールJSON
  └→ DB: ルール保存
      ↓
  ルールエンジン: エントリー監視開始
```

### 4.2 ポジション監視フロー

```
エントリー実行
  ↓
ポジション保有状態

15分ごと - Layer 3a定期評価
  ├→ AI: Gemini Flash-Lite
  ├→ 判定: OK/WARNING/DANGER
  ├→ DANGER → Layer 3bへ
  └→ 決済指示あり → 実行

Layer 2トリガー時 - Layer 3b緊急評価
  ├→ AI: Gemini Pro (詳細分析)
  ├→ 判定: 予測の妥当性
  ├→ 決済判断: 保持/部分/全決済
  └→ 緊急度に応じて実行
```

---

## 5. 設計原則

### 5.1 再現性の確保

**原則**: 同じ市場データから同じ判断を生成

**実現方法**:
- AI温度パラメータを低く設定 (temperature=0.3)
- 全プロンプトとデータのバージョン管理
- 入力データのハッシュ化
- 実行記録の完全保存

**目的**:
- バックテストでの検証可能性
- トレード判断の追跡
- 継続的改善

### 5.2 柔軟性と適応性

**原則**: 市場環境の変化に適応

**実現方法**:
- 日次の戦略更新
- 前日の振り返りからの学習
- 定期的な妥当性確認
- リアルタイム再評価

**目的**:
- 市場の変化への対応
- 過去の失敗からの学習
- パフォーマンス向上

### 5.3 コスト効率

**原則**: 最小コストで最大効果

**実現方法**:
- 従量課金モデルの活用
- 用途に応じたモデル選択
- プロンプトの最適化
- 不要な呼び出しの削減

**達成**:
- 月額$1.43の超低コスト

---

## 6. AIモデル選択戦略

### 6.1 モデル選択基準

| シーン | 求められる特性 | 選択モデル | 理由 |
|-------|--------------|-----------|------|
| **前日振り返り** | 高精度分析 | Gemini Pro | 詳細な評価が必要 |
| **朝の詳細分析** | 高精度戦略生成 | Gemini Pro | 1日の基礎となる重要判断 |
| **定期更新** | 中精度・高速 | Gemini Flash | 簡単な妥当性確認 |
| **15分評価** | 超高速・超低コスト | Gemini Flash-Lite | 簡易チェックのみ |
| **緊急評価** | 高精度判断 | Gemini Pro | 重要な決済判断 |

### 6.2 コスト最適化

**基本方針**:
- 重要な判断には高精度モデル
- 定型的な確認には軽量モデル
- プロンプト長の最適化

**1日のコスト構造**:
```
Pro (3回):    $0.06  (振り返り + 朝分析 + 緊急時)
Flash (3回):  $0.006 (定期更新)
Flash-Lite (10回): $0.003 (15分評価)
────────────────────
合計:         $0.069/日 → $1.52/月
```

---

## 7. ルールJSON仕様

### 7.1 構造概要

AI分析の出力は、実行可能なルールJSON形式:

```json
{
  "daily_bias": "BUY/SELL/NEUTRAL",
  "confidence": 0.0〜1.0,
  "entry_conditions": {...},
  "exit_strategy": {...},
  "risk_management": {...},
  "key_levels": {...}
}
```

### 7.2 主要セクション

| セクション | 内容 | 利用層 |
|-----------|------|--------|
| **daily_bias** | 本日のトレード方向 | ルール実行層 |
| **entry_conditions** | エントリー条件 | エントリー監視 |
| **exit_strategy** | 決済戦略 | 決済監視 |
| **risk_management** | リスク管理パラメータ | ポジションサイズ計算 |
| **key_levels** | 重要価格レベル | Layer 2異常検知 |

---

## 8. プロンプト管理

### 8.1 プロンプトのバージョン管理

**管理項目**:
- プロンプトテキスト
- バージョン番号 (v1.2.3形式)
- 作成日・更新日
- 変更理由

**保存方法**:
```
prompts/
  ├── morning_analysis_v1.2.3.txt
  ├── review_v1.1.0.txt
  ├── update_v1.0.5.txt
  └── position_eval_v2.0.1.txt
```

### 8.2 実行記録

**データベース記録**:
- 実行時刻
- 使用したプロンプトバージョン
- 入力データハッシュ
- AIモデル名
- 入力/出力トークン数
- コスト
- 応答JSON

**目的**:
- 再現性の確保
- コスト追跡
- プロンプト改善

---

## 9. パフォーマンス要件

### 9.1 応答時間目標

| 分析タイプ | 目標 | 許容最大 |
|-----------|------|---------|
| **前日振り返り** | 5秒 | 10秒 |
| **朝の詳細分析** | 8秒 | 15秒 |
| **定期更新** | 3秒 | 8秒 |
| **Layer 3a評価** | 1秒 | 3秒 |
| **Layer 3b評価** | 5秒 | 10秒 |

### 9.2 精度目標

**Phase 4バックテストで評価**:

| 指標 | 目標値 |
|------|--------|
| **方向性的中率** | 65%以上 |
| **判断の一貫性** | 90%以上 (3回実行で同じ結果) |
| **エントリー判断妥当性** | 70%以上 |

---

## 10. エラーハンドリング

### 10.1 API呼び出しエラー

**対応フロー**:
```
API呼び出し失敗
  ↓
再試行 (最大3回、指数バックオフ: 2s, 4s, 8s)
  ↓ 成功
通常処理
  ↓ 失敗
直前の判断を継続使用
アラート送信
```

### 10.2 不正なJSON出力

**対応フロー**:
```
JSON パース失敗
  ↓
AI再実行 (修正指示付き)
  ↓ 成功
通常処理
  ↓ 2回失敗
保守的なデフォルト判断使用
  (daily_bias: NEUTRAL, should_trade: false)
```

### 10.3 コスト超過

**監視**:
- 日次上限: $0.20
- 月次上限: $5.00

**超過時の対応**:
- Layer 3a頻度を30分に延長
- アラート送信
- 管理者確認まで一時停止

---

## 11. まとめ

### 11.1 アーキテクチャの特徴

1. **階層化された分析**: 戦略層・調整層・監視層の3層構造
2. **適応的学習**: 前日の振り返りから継続的改善
3. **コスト最適化**: 用途に応じたモデル選択で月$1.43
4. **再現性**: 全データ・全判断の記録とバージョン管理
5. **柔軟性**: 市場変化への日次・時間内での適応

### 11.2 次のステップ

詳細な実装仕様については、以下を参照:
- [詳細設計書: AI分析エンジン](../architecture/02_ai_analysis_engine.md)

---

**本書は基本設計レベルのアーキテクチャを示しています。**
**実装の詳細は詳細設計書を参照してください。**

# リスク管理アーキテクチャ（基本設計）

## ドキュメント情報
- **作成日**: 2025-10-21
- **バージョン**: 1.0
- **種別**: 基本設計書
- **対応する詳細設計**: [09_risk_management.md](../architecture/09_risk_management.md)

---

## 1. 概要

### 1.1 役割

多層防御による口座保護とリスクの統合的管理を担うアーキテクチャ

### 1.2 位置づけ

```
リスク管理層はシステム全体に横断的に関与

データ層 ──┐
AI判断層 ──┼→ [リスク管理層] → 安全な運用
実行層 ────┘
```

リスク管理層は、全てのレイヤーに安全装置を配置し、総合的に口座を保護する

---

## 2. アーキテクチャ構成

### 2.1 全体像

```
┌─────────────────────────────────────────┐
│       リスク管理アーキテクチャ             │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ 多層防御システム                  │   │
│  │                                   │   │
│  │  [Level 1] 保険ストップロス       │   │
│  │    - MT5に口座5%で設定           │   │
│  │    - 最終防衛線                  │   │
│  │                                   │   │
│  │  [Level 2] Layer 1緊急停止       │   │
│  │    - 口座2%で即決済              │   │
│  │    - 50pipsハードストップ         │   │
│  │    - 100ms高速監視               │   │
│  │                                   │   │
│  │  [Level 3] Layer 2異常検知       │   │
│  │    - サポレジブレイク             │   │
│  │    - 指標反転                    │   │
│  │    - Layer 3へエスカレーション    │   │
│  │                                   │   │
│  │  [Level 4] Layer 3 AI判断        │   │
│  │    - 定期/緊急評価               │   │
│  │    - 柔軟な意思決定              │   │
│  │                                   │   │
│  └─────────────────────────────────┘   │
│            ↓                            │
│  ┌─────────────────────────────────┐   │
│  │ ポジションサイズ管理              │   │
│  │  - 基本ロット設定                │   │
│  │  - AI信頼度による調整            │   │
│  │  - ボラティリティ考慮            │   │
│  └─────────────────────────────────┘   │
│            ↓                            │
│  ┌─────────────────────────────────┐   │
│  │ ドローダウン管理                  │   │
│  │  - 段階的対応 (5%, 7%, 10%)      │   │
│  │  - ポジションサイズ縮小           │   │
│  │  - エントリー条件厳格化           │   │
│  │  - トレード停止                  │   │
│  └─────────────────────────────────┘   │
│            ↓                            │
│  ┌─────────────────────────────────┐   │
│  │ 定期レビュー                      │   │
│  │  - 週次パフォーマンス分析         │   │
│  │  - 月次総合評価                  │   │
│  │  - 改善点抽出                    │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 2.2 リスク管理の階層

| 階層 | 機能 | タイミング | 目的 |
|------|------|-----------|------|
| **予防** | ポジションサイズ管理 | エントリー前 | リスクの限定 |
| **即時** | Layer 1緊急停止 | リアルタイム | 致命的損失防止 |
| **早期** | Layer 2異常検知 | リアルタイム | 問題の早期発見 |
| **柔軟** | Layer 3 AI判断 | 定期/トリガー時 | 適応的対応 |
| **総合** | ドローダウン管理 | 継続的 | 口座全体の保護 |
| **改善** | 定期レビュー | 週次/月次 | 継続的改善 |

---

## 3. 主要コンポーネント

### 3.1 多層防御システム

#### Level 1: 保険ストップロス

**設定**: MT5に口座の5%

**目的**: システム障害時の最終防衛線

**例**:
- 口座: $100,000
- ポジション: 0.1 lot
- 保険SL: 約500pips離れた位置
- 想定損失: $5,000 (5%)

**特徴**:
- MT5サーバー側で管理
- システム停止時も機能
- 滅多に発動しない

#### Level 2: Layer 1緊急停止

**条件**:
- 口座の2%損失
- ハードストップ50pips
- スプレッド異常 (>20pips)
- フラッシュクラッシュ

**監視**: 100msごと

**処理**: 即座に成行決済

**特徴**:
- 完全ルールベース
- AI判断を待たない
- 独立プロセスで稼働

#### Level 3: Layer 2異常検知

**条件**:
- 重要レベルブレイク
- インジケーター反転
- 連続逆行
- RSI過熱

**監視**: 1分/5分ごと

**処理**: Layer 3へエスカレーション

**特徴**:
- 早期警告システム
- 柔軟な判断へつなぐ

#### Level 4: Layer 3 AI判断

**種類**:
- 定期評価 (15分)
- 緊急評価 (トリガー時)

**処理**:
- 状況の詳細分析
- 決済判断 (保持/部分/全決済)
- ストップロス調整

**特徴**:
- AI による柔軟性
- 市場環境への適応

### 3.2 ポジションサイズ管理

**基本方針**: 保守的なサイジング

**計算ロジック**:
```
基本ロット = 0.1 lot
調整倍率 = position_size_multiplier (0.5〜1.0)
最終ロット = 基本ロット × 調整倍率
```

**調整要因**:
- AI信頼度 (confidence)
- 市場ボラティリティ (ATR)
- 口座残高
- ドローダウン状況

**Phase 1-4の制約**:
- 最大ポジション数: 1
- 最小ロット: 0.05 lot
- 最大ロット: 0.1 lot

### 3.3 ドローダウン管理

**段階的対応システム**:

#### 5%到達: 警戒レベル
```
対応:
  - ポジションサイズを50%に縮小
  - エントリー条件を厳格化 (confidence >= 0.7)
  - 監視強化
```

#### 7%到達: 危険レベル
```
対応:
  - ポジションサイズを最小 (0.05 lot)
  - 確信度0.8以上のみエントリー
  - Layer 3頻度を10分に短縮
```

#### 10%到達: 停止レベル
```
対応:
  - 全トレード停止
  - 徹底的な分析と改善
  - 再開には明確な改善策が必要
```

### 3.4 定期レビュー

#### 週次レビュー

**分析項目**:
- 週間損益
- ドローダウンの推移
- 勝率、プロフィットファクター
- AI判断精度
- システム稼働状況

**目的**:
- 早期の問題発見
- 短期トレンドの把握

#### 月次レビュー

**分析項目**:
- 月間総合パフォーマンス
- バックテストとの比較
- AI判断精度の推移
- リスク指標の評価
- システム全体の改善点

**目的**:
- 長期的な改善
- 戦略の見直し
- プロンプト最適化

---

## 4. リスク指標

### 4.1 主要指標

| 指標 | 目標値 | 監視頻度 |
|------|--------|---------|
| **最大ドローダウン** | 10%以下 | リアルタイム |
| **月次勝率** | 60%以上 | 月次 |
| **プロフィットファクター** | 1.5以上 | 月次 |
| **リスクリワード比** | 1:2以上 | トレードごと |
| **最大連続負け** | 5回以下 | 継続監視 |

### 4.2 アラート基準

| 状況 | 基準 | 対応 |
|------|------|------|
| **ドローダウン警戒** | 5%到達 | ポジションサイズ縮小 |
| **ドローダウン危険** | 7%到達 | エントリー厳格化 |
| **ドローダウン停止** | 10%到達 | トレード停止 |
| **連続負け** | 3回連続 | 原因分析、一時停止検討 |
| **勝率低下** | 月次40%未満 | 戦略見直し |

---

## 5. データフロー

### 5.1 リアルタイムリスク監視

```
ポジション保有中

100msごと:
  ├→ 現在含み損益計算
  ├→ 口座残高比率チェック
  ├→ 2%超過 → Layer 1発動
  └→ 50pips逆行 → Layer 1発動

1分ごと:
  ├→ ドローダウン計算
  ├→ 警戒レベル判定
  └→ 必要時: 制約適用

リアルタイム:
  └→ リスク指標の更新
```

### 5.2 レビューフロー

```
週末 - 週次レビュー
  ├→ DB: 週間データ集計
  ├→ 分析: パフォーマンス評価
  ├→ 問題点の特定
  └→ 改善アクション決定

月末 - 月次レビュー
  ├→ DB: 月間データ集計
  ├→ AI判断精度分析
  ├→ バックテスト比較
  ├→ 総合評価
  └→ 戦略・プロンプト見直し
```

---

## 6. 設計原則

### 6.1 安全性最優先

**原則**: 利益よりも損失の防止を優先

**実現方法**:
- 多層防御システム
- 保守的なポジションサイジング
- 段階的ドローダウン対応
- 強制停止メカニズム

### 6.2 段階的対応

**原則**: リスクレベルに応じた段階的対応

**実現方法**:
- 4層の防御レベル
- ドローダウンの3段階対応
- エスカレーションパス

### 6.3 継続的改善

**原則**: データに基づく改善サイクル

**実現方法**:
- 全データの記録
- 定期的なレビュー
- フィードバックループ
- A/Bテスト可能な設計

---

## 7. 週末・祝日対応

### 7.1 週末停止

**金曜日 23:00**:
```
処理:
  - 全ポジション強制決済
  - 新規エントリー停止
  - Layer 1のみ継続稼働 (万が一の保護)
```

**月曜日 07:00**:
```
処理:
  - 全機能自動復帰
  - システムヘルスチェック
  - 週次レビュー (自動)
```

### 7.2 重要指標発表

**対応**:
- 発表30分以内はエントリー見送り
- ポジション保有中は Layer 1/2/3 継続監視
- 将来的に経済指標カレンダー統合予定

---

## 8. 緊急時対応

### 8.1 システム障害

**対応フロー**:
```
システム障害検知
  ↓
保険ストップロス (MT5設定) が機能
  ↓
Layer 1の独立プロセス継続稼働
  ↓
緊急アラート送信
  ↓
手動介入の準備
```

### 8.2 市場急変

**対応フロー**:
```
市場急変検知 (Layer 1)
  ├→ フラッシュクラッシュ → 即決済
  ├→ スプレッド異常 → 即決済
  └→ 急激な逆行 → Layer 2へ
      └→ Layer 3で詳細判断
```

### 8.3 口座残高急減

**対応フロー**:
```
口座残高監視
  ↓
2%損失検知 → Layer 1即決済
  ↓
5%ドローダウン → 警戒モード
  ↓
7%ドローダウン → 危険モード
  ↓
10%ドローダウン → トレード停止
```

---

## 9. パフォーマンス要件

### 9.1 リスク計算速度

| 処理 | 目標時間 |
|------|---------|
| **リアルタイムリスク計算** | 50ms以内 |
| **ドローダウン計算** | 100ms以内 |
| **週次レビュー** | 30秒以内 |
| **月次レビュー** | 5分以内 |

### 9.2 監視信頼性

| 指標 | 目標値 |
|------|--------|
| **Layer 1稼働率** | 99.9%以上 |
| **リスク監視継続性** | 100% |
| **アラート送信成功率** | 99%以上 |

---

## 10. まとめ

### 10.1 アーキテクチャの特徴

1. **多層防御**: 4層の独立した安全装置
2. **段階的対応**: リスクレベルに応じた柔軟な対応
3. **予防重視**: ポジションサイズ管理で事前リスク限定
4. **継続改善**: 定期レビューによる改善サイクル
5. **独立稼働**: Layer 1の完全独立による最終保護

### 10.2 安全性の保証

リスク管理アーキテクチャは以下を保証:
- 致命的損失の防止 (最大10%)
- システム障害時の保護継続
- 市場急変への即応
- 段階的な早期警告
- データに基づく継続改善

### 10.3 次のステップ

詳細な実装仕様については、以下を参照:
- [詳細設計書: リスク管理](../architecture/09_risk_management.md)

---

**本書は基本設計レベルのアーキテクチャを示しています。**
**実装の詳細は詳細設計書を参照してください。**

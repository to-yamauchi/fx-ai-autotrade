# FX自動トレードシステム - システムアーキテクチャ概要（基本設計）

## ドキュメント情報
- **作成日**: 2025-10-21
- **バージョン**: 1.0
- **種別**: 基本設計書
- **対象読者**: 開発者、システム設計者、プロジェクトマネージャー

---

## 目次
1. [システム概要](#1-システム概要)
2. [アーキテクチャの全体像](#2-アーキテクチャの全体像)
3. [主要コンポーネント](#3-主要コンポーネント)
4. [データフロー](#4-データフロー)
5. [技術スタック](#5-技術スタック)
6. [システム特性](#6-システム特性)
7. [拡張性と将来計画](#7-拡張性と将来計画)

---

## 1. システム概要

### 1.1 目的

AIと確定的データを組み合わせた、安全で再現可能なFX自動トレードシステムの構築

### 1.2 基本コンセプト

**3層アーキテクチャ: データ層 → AI判断層 → 高速実行層**

```
確定的データ層 (Data Layer)
  ↓ 標準化されたデータ
AI判断層 (Intelligence Layer)
  ↓ 実行可能なルール
高速実行層 (Execution Layer)
```

### 1.3 設計思想

| 原則 | 説明 | 実現方法 |
|------|------|----------|
| **再現性** | 同じ市場データから同じ判断を生成 | 低温度AI設定、全データ記録 |
| **安全性** | 致命的損失を防止 | 多層防御システム |
| **柔軟性** | 市場変化に適応 | AI判断の日次更新 |
| **段階性** | 基礎から順に構築 | 6フェーズのロードマップ |

---

## 2. アーキテクチャの全体像

### 2.1 システム全体図

```
┌─────────────────────────────────────────────────────────────┐
│                    スケジューラ                                │
│              (週末停止・定時実行制御)                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                データ処理エンジン                               │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ MT5接続     │→ │ 時間足変換    │→ │ 指標計算     │     │
│  └─────────────┘  └──────────────┘  └──────────────┘     │
│                           ↓                                  │
│                   標準化データ生成                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  AI分析エンジン                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ 前日振り返り  │  │ 朝の詳細分析  │  │ 定期更新     │    │
│  │ (Gemini Pro) │  │ (Gemini Pro) │  │ (Gemini Flash)│    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│                           ↓                                  │
│                  実行可能なルールJSON                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  ルールエンジン (高速実行)                      │
│  ┌────────────────────────────────────────────────────┐    │
│  │ Layer 1: 緊急停止 (100ms監視)                       │    │
│  │  - 口座2%損失 / ハードストップ / 異常検知            │    │
│  ├────────────────────────────────────────────────────┤    │
│  │ Layer 2: 異常検知 (1分/5分監視)                     │    │
│  │  - サポレジブレイク / 指標反転 / 連続逆行            │    │
│  ├────────────────────────────────────────────────────┤    │
│  │ Layer 3: AI再評価                                   │    │
│  │  - 定期評価(15分) / 緊急評価(トリガー時)             │    │
│  └────────────────────────────────────────────────────┘    │
│  ┌──────────────┐  ┌──────────────┐                       │
│  │ エントリー監視 │  │ 決済監視     │                       │
│  └──────────────┘  └──────────────┘                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   MT5 トレード実行                             │
│           (エントリー / 決済 / ストップロス設定)                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    データベース                                │
│  - トレード記録  - AI判断履歴  - 市場データ  - 分析結果        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 レイヤー分離の設計

| レイヤー | 責務 | 更新頻度 | 主要技術 |
|---------|------|----------|---------|
| **データ層** | 市場データ取得・標準化 | 100ms〜1分 | MT5 API, Python |
| **AI判断層** | 戦略生成・判断 | 15分〜1日 | Gemini API |
| **実行層** | ルール実行・監視 | 100ms〜5分 | ルールベース処理 |
| **永続化層** | データ保存・分析 | トランザクション毎 | PostgreSQL |

---

## 3. 主要コンポーネント

### 3.1 データ処理エンジン

**役割**: 市場データの取得と標準化

**主要機能**:
- MT5からのティックデータ取得
- 複数時間足への変換 (D1, H4, H1, M15)
- テクニカル指標の計算 (EMA, RSI, MACD, ATR, BB等)
- AI解釈可能な標準フォーマットへの変換

**出力**: 標準化されたJSON形式の市場データセット

**詳細設計**: [01_data_processing_engine.md](./architecture/01_data_processing_engine.md)

### 3.2 AI分析エンジン

**役割**: 市場分析と実行可能な戦略の生成

**主要機能**:
- 前日のトレード振り返りと教訓抽出
- 朝の詳細市場分析と戦略生成
- 定期的な戦略の妥当性確認
- ポジション保有中のリアルタイム再評価

**使用AI**:
- Gemini 2.5 Pro (高精度分析)
- Gemini 2.5 Flash (定期更新)
- Gemini 2.5 Flash-Lite (15分評価)

**コスト**: 月額約$1.43 (従量課金)

**出力**: 実行可能なルールJSON

**詳細設計**: [02_ai_analysis_engine.md](./architecture/02_ai_analysis_engine.md)

### 3.3 ルールエンジン

**役割**: AI生成ルールの高速実行と3層監視

**3層監視構造**:

#### Layer 1: 緊急停止 (100ms監視)
- 口座の2%損失で即決済
- ハードストップ50pips
- スプレッド異常検知
- フラッシュクラッシュ検知

#### Layer 2: 異常検知 (1分/5分監視)
- 重要レベルブレイク
- インジケーター反転
- 連続逆行の検知

#### Layer 3: AI再評価
- 定期評価 (15分ごと)
- 緊急評価 (Layer 2トリガー時)

**特徴**: AIを介さない高速処理で安全性確保

**詳細設計**: [03_rule_engine.md](./architecture/03_rule_engine.md)

### 3.4 トレード実行システム

**役割**: MT5への注文実行と管理

**主要機能**:
- エントリー条件の継続的監視
- ポジションサイズの動的調整
- 段階的利確の実行
- トレーリングストップの管理
- 時間管理 (23:00強制決済)

**詳細設計**: [07_trade_execution_system.md](./architecture/07_trade_execution_system.md)

### 3.5 監視・決済システム

**役割**: ポジションの継続監視と決済判断

**主要機能**:
- 利確レベルの監視と段階的決済
- ストップロスの動的調整
- インジケーターベースの決済
- 時間ベースの決済

**詳細設計**: [05_monitoring_settlement_system.md](./architecture/05_monitoring_settlement_system.md)

### 3.6 データベース

**役割**: 全記録の永続化

**保存データ**:
- トレード記録 (エントリー/決済の全詳細)
- AI判断履歴 (プロンプトと応答)
- 市場データスナップショット
- バックテスト結果

**技術**: PostgreSQL (JSONB型活用)

**詳細設計**: [04_database.md](./architecture/04_database.md)

### 3.7 バックテストシステム

**役割**: AI判断の再現性検証

**主要機能**:
- 過去データでのAI判断の再実行
- 判断の一貫性確認 (同じデータで複数回実行)
- 方向性的中率の評価
- 仮想損益の計算

**詳細設計**: [08_backtest_specification.md](./architecture/08_backtest_specification.md)

### 3.8 リスク管理システム

**役割**: 多層防御による口座保護

**主要機能**:
- ポジションサイズ管理
- ドローダウン監視と段階的対応
- 週次・月次レビュー
- 緊急停止判断

**詳細設計**: [09_risk_management.md](./architecture/09_risk_management.md)

### 3.9 スケジューラ

**役割**: 定時実行と週末停止の制御

**主要機能**:
- 定時AI分析の実行 (06:00, 08:00, 12:00, 16:00, 21:30)
- 週末の自動停止・再開
- 強制決済タイミングの管理 (23:00)

**詳細設計**: [10_operation_schedule.md](./architecture/10_operation_schedule.md)

---

## 4. データフロー

### 4.1 朝の戦略生成フロー

```
06:00 - 前日振り返り
  ├→ 前日トレード記録取得 (DB)
  ├→ AI分析 (Gemini Pro)
  └→ 教訓抽出・記録 (DB)

08:00 - 朝の詳細分析
  ├→ 市場データ取得 (MT5)
  ├→ データ標準化 (データ処理エンジン)
  ├→ AI分析 (Gemini Pro + 前日の教訓)
  ├→ ルールJSON生成
  └→ ルール記録 (DB)

→ エントリー監視開始 (ルールエンジン)
```

### 4.2 エントリー実行フロー

```
継続監視 (1分ごと)
  ├→ 現在価格取得
  ├→ エントリー条件チェック
  │   ├─ 価格ゾーン確認
  │   ├─ 必須シグナル確認
  │   └─ 回避条件確認
  ├→ 全条件クリア
  │   └→ MT5注文実行
  │       ├→ ポジションサイズ計算
  │       ├→ ストップロス設定
  │       └→ トレード記録 (DB)
  └→ 監視継続
```

### 4.3 監視・決済フロー

```
ポジション保有中

Layer 1 (100ms)
  └→ 緊急条件チェック → 即決済

Layer 2 (1分/5分)
  └→ 異常検知 → Layer 3へエスカレーション

Layer 3 (15分 or トリガー時)
  ├→ AI再評価
  └→ 決済判断

決済監視 (1分)
  ├→ 利確レベル到達 → 段階的決済
  ├→ トレーリングストップ更新
  └→ 時間管理 (23:00強制決済)
```

### 4.4 データ記録フロー

```
全イベント
  ↓
データベース記録
  ├→ トレード記録
  ├→ AI判断履歴
  ├→ 市場データスナップショット
  └→ 異常イベント記録
      ↓
分析・改善に活用
  ├→ バックテスト検証
  ├→ パフォーマンス分析
  └→ プロンプト最適化
```

---

## 5. 技術スタック

### 5.1 プログラミング言語

| 用途 | 言語 | 理由 |
|------|------|------|
| **メインシステム** | Python 3.10+ | MT5 API対応、データ処理に最適 |
| **データベース** | SQL (PostgreSQL) | JSONB型でルール保存 |

### 5.2 主要ライブラリ・API

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **トレードAPI** | MetaTrader5 Python API | 市場データ取得、注文実行 |
| **AI/LLM** | Gemini API | 市場分析、戦略生成 |
| **データ分析** | pandas, numpy | データ処理、指標計算 |
| **テクニカル指標** | TA-Lib または pandas-ta | EMA, RSI, MACD等の計算 |
| **データベース** | PostgreSQL + psycopg2 | データ永続化 |
| **スケジューリング** | APScheduler | 定時実行制御 |

### 5.3 インフラ

| コンポーネント | 技術 | 備考 |
|--------------|------|------|
| **実行環境** | Linux (Ubuntu推奨) | 24時間稼働 |
| **VPS** | 任意 (オプション) | 安定性重視の場合 |
| **データベース** | PostgreSQL 14+ | ローカルまたはクラウド |
| **MT5接続** | MetaTrader5 ターミナル | Windows or Wine (Linux) |

### 5.4 コスト構造

| 項目 | 月額コスト | 備考 |
|------|-----------|------|
| **Gemini API** | $1.43 | 従量課金 (基本プラン) |
| **VPS** | $0〜30 | オプション |
| **データベース** | $0 | セルフホスト |
| **合計** | $1.43〜31 | 非常に低コスト |

---

## 6. システム特性

### 6.1 非機能要件

#### 6.1.1 パフォーマンス

| 指標 | 目標値 | 用途 |
|------|--------|------|
| **Layer 1応答** | 100ms以内 | 緊急停止 |
| **データ取得** | 3秒以内 | 標準化データ生成 |
| **AI分析** | 5〜8秒 | 戦略生成 |
| **エントリー判断** | 1秒以内 | リアルタイム監視 |

#### 6.1.2 可用性

| 指標 | 目標値 |
|------|--------|
| **システム稼働率** | 99%以上 |
| **データ取得成功率** | 99.5%以上 |
| **週末停止** | 自動 (金曜23:00〜月曜07:00) |

#### 6.1.3 再現性

| 指標 | 目標値 |
|------|--------|
| **AI判断の一貫性** | 90%以上 (同じデータで複数回実行) |
| **バックテスト再現性** | 100% (同一条件) |

### 6.2 安全性

#### 多層防御システム

```
Level 1: 保険ストップロス (MT5設定)
  └→ 口座の5% (最終防衛線)

Level 2: Layer 1緊急停止
  └→ 口座の2%、50pips (100ms監視)

Level 3: Layer 2異常検知
  └→ サポレジブレイク、指標反転 (1分/5分)

Level 4: Layer 3 AI判断
  └→ 柔軟な意思決定 (15分/トリガー時)

Level 5: ドローダウン管理
  └→ 5%/7%/10%で段階的対応
```

### 6.3 拡張性

**現在の対応**:
- 通貨ペア: USDJPY のみ
- トレードスタイル: デイトレード (M15ベース)
- ポジション数: 1

**将来拡張可能**:
- 複数通貨ペア対応
- 複数時間軸エントリー
- ニュース統合
- 機械学習モデル追加

---

## 7. 拡張性と将来計画

### 7.1 段階的実装計画

```
Phase 1-2 (Week 1-2): 基礎実装
  └→ データ処理、安全装置

Phase 2 (Week 3): AI統合
  └→ 分析機能、ルール生成

Phase 3 (Week 3-4): トレード実行
  └→ 完全自動化

Phase 4 (Week 4): バックテスト
  └→ 信頼性検証

Phase 5 (Week 5-8): デモ運用
  └→ 実環境調整

Phase 6 (Week 9-): 本番運用
  └→ 実資金トレード

Phase 7 (将来): 拡張機能
  └→ 機能追加
```

### 7.2 将来の拡張候補

| 拡張機能 | 説明 | 優先度 |
|---------|------|--------|
| **ニュース統合** | ファンダメンタルズ分析追加 | 中 |
| **複数通貨ペア** | EURUSD, GBPUSD等への拡張 | 高 |
| **複数時間軸** | スキャルピング、スイング追加 | 中 |
| **機械学習** | パターン学習モデル追加 | 低 |
| **通知システム** | Slack/LINE通知 | 高 |
| **高度リスク管理** | ポートフォリオVaR計算 | 中 |

### 7.3 アーキテクチャの柔軟性

**設計の工夫**:
- レイヤー分離により各層を独立して拡張可能
- ルールJSON形式により新戦略の追加が容易
- データベース設計により新データ項目の追加に対応
- API統合により新しいAIモデルへの切り替えが容易

---

## 8. 関連ドキュメント

### 8.1 詳細設計書

| ドキュメント | 説明 |
|-------------|------|
| [01_data_processing_engine.md](./architecture/01_data_processing_engine.md) | データ処理エンジンの詳細設計 |
| [02_ai_analysis_engine.md](./architecture/02_ai_analysis_engine.md) | AI分析エンジンの詳細設計 |
| [03_rule_engine.md](./architecture/03_rule_engine.md) | ルールエンジンの詳細設計 |
| [04_database.md](./architecture/04_database.md) | データベース設計 |
| [05_monitoring_settlement_system.md](./architecture/05_monitoring_settlement_system.md) | 監視・決済システムの詳細設計 |
| [06_data_specifications.md](./architecture/06_data_specifications.md) | データ仕様の詳細 |
| [07_trade_execution_system.md](./architecture/07_trade_execution_system.md) | トレード実行システムの詳細設計 |
| [08_backtest_specification.md](./architecture/08_backtest_specification.md) | バックテスト仕様 |
| [09_risk_management.md](./architecture/09_risk_management.md) | リスク管理の詳細設計 |
| [10_operation_schedule.md](./architecture/10_operation_schedule.md) | 運用スケジュールの詳細 |

### 8.2 全体仕様書

| ドキュメント | 説明 |
|-------------|------|
| [FX_AUTO_TRADE_SPECIFICATION.md](../FX_AUTO_TRADE_SPECIFICATION.md) | システム全体の詳細仕様書 |

---

## 9. まとめ

### 9.1 アーキテクチャの特徴

1. **3層分離設計**: データ層、AI判断層、実行層を明確に分離
2. **安全性最優先**: 多層防御による口座保護
3. **再現性確保**: 全データ・全判断の記録とバックテスト検証
4. **低コスト運用**: 月額$1.43の従量課金AI活用
5. **段階的実装**: 基礎から順に構築し、各段階で検証

### 9.2 システムの強み

| 強み | 説明 |
|------|------|
| **再現性** | 同じデータから同じ判断を生成 |
| **安全性** | 4層の防御システム |
| **学習能力** | 日次の振り返りと改善 |
| **コスト効率** | 極めて低い運用コスト |
| **拡張性** | 段階的な機能追加が容易 |

### 9.3 次のステップ

1. 詳細設計書の確認と理解
2. Phase 1実装の着手
3. 開発環境のセットアップ
4. データ処理機能の実装開始

---

**本書は基本設計レベルのアーキテクチャ概要を示しています。**
**実装詳細については各詳細設計書を参照してください。**
